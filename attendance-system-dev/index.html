<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Attendance System - MySQL Powered</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-500: #64748b;
            --gray-700: #334155;
            --gray-900: #0f172a;
            --white: #fff
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            min-height: 100vh;
            color: var(--gray-900)
        }

        .screen {
            display: none
        }

        .screen.active {
            display: block
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, .1);
            margin-bottom: 24px;
            border: 1px solid var(--gray-200);
            /* allow grid/flex children to shrink on small windows */
            min-width: 0;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px
        }

        .login-card {
            background: var(--white);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, .25);
            width: 100%;
            max-width: 400px
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
            text-align: center
        }

        .login-subtitle {
            color: var(--gray-500);
            text-align: center;
            margin-bottom: 32px
        }

        .form-group {
            margin-bottom: 20px
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 14px
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 16px;
            transition: all .2s ease;
            background: var(--white)
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, .1)
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s ease;
            text-decoration: none;
            min-height: 48px
        }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white)
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .1)
        }

        .btn-secondary {
            background: var(--gray-500);
            color: var(--white)
        }

        .btn-success {
            background: var(--success-color);
            color: var(--white)
        }

        .btn-full-width {
            width: 100%
        }

        .signup-link,
        .login-link {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--gray-200)
        }

        .signup-link a,
        .login-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600
        }

        .demo-credentials {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
            text-align: center;
            border: 1px solid var(--gray-200)
        }

        .demo-credentials h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px
        }

        .demo-credentials p {
            font-size: 14px;
            color: var(--gray-600);
            margin: 4px 0
        }

        .header {
            background: var(--white);
            border-radius: 16px;
            padding: 20px 32px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900)
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 16px
        }

        .user-welcome {
            font-weight: 600;
            color: var(--gray-700)
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px
        }

        .stat-card {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1);
            border-left: 4px solid var(--primary-color);
            transition: transform .2s ease
        }

        .stat-card:hover {
            transform: translateY(-2px)
        }

        .stat-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: .05em;
            margin-bottom: 8px
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px
        }

        .stat-card-value.success {
            color: var(--success-color)
        }

        .stat-card-value.warning {
            color: var(--warning-color)
        }

        .stat-card-value.error {
            color: var(--error-color)
        }

        .stat-card-timing {
            font-size: 14px;
            color: var(--gray-500)
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px
        }

        .action-card {
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1);
            border: 2px solid var(--gray-200);
            cursor: pointer;
            transition: all .2s ease;
            text-align: center
        }

        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, .1);
            border-color: var(--primary-color)
        }

        .action-card-icon {
            font-size: 48px;
            margin-bottom: 16px;
            display: block
        }

        .action-card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px
        }

        .action-card-description {
            color: var(--gray-500);
            font-size: 14px;
            line-height: 1.5
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px
        }

        .office-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 24px 0
        }

        .office-card {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all .2s ease;
            text-align: center;
            position: relative
        }

        .office-card:hover,
        .office-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
            transform: translateY(-2px)
        }

        .office-card.disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .office-card h3 {
            color: var(--gray-900);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px
        }

        .office-card p {
            color: var(--gray-600);
            font-size: 14px;
            margin-bottom: 16px
        }

        .location-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase
        }

        .location-status.checking {
            background: var(--gray-100);
            color: #6b7280
        }

        .location-status.in-range {
            background: #dcfce7;
            color: #166534
        }

        .location-status.out-of-range {
            background: #fef3c7;
            color: #92400e
        }

        .location-status.error {
            background: #fed7d7;
            color: #742a2a
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 4/3
        }

        .camera-container video,
        .camera-container img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap
        }

        /* --- Admin layout & tables: responsive fixes --- */
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px
        }

        @media (max-width:1200px) {
            .admin-grid {
                grid-template-columns: 1fr
            }
        }

        .table-wrap {
            max-width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1);
            min-width: 860px
        }

        .records-table th,
        .records-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: top;
            white-space: nowrap
        }

        .records-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 14px
        }

        .records-table tr:hover {
            background: var(--gray-50)
        }

        @media (max-width:900px) {

            .records-table th:nth-child(2),
            .records-table td:nth-child(2),
            .records-table th:nth-child(3),
            .records-table td:nth-child(3),
            .records-table th:nth-child(4),
            .records-table td:nth-child(4) {
                white-space: normal;
                word-break: break-word
            }
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase
        }

        .status-present {
            background: #dcfce7;
            color: #166534
        }

        .status-wfh {
            background: #dbeafe;
            color: #1e40af
        }

        .status-half_day {
            background: #fef3c7;
            color: #92400e
        }

        .status-client {
            background: #e0e7ff;
            color: #3730a3
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: var(--white);
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform .3s ease;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .1)
        }

        .notification.show {
            transform: translateX(0)
        }

        .notification.success {
            background: var(--success-color)
        }

        .notification.error {
            background: var(--error-color)
        }

        .notification.warning {
            background: var(--warning-color)
        }

        .hidden {
            display: none !important
        }

        .text-center {
            text-align: center
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000
        }

        .modal.active {
            display: flex
        }

        .modal-content {
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, .25)
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        @media (max-width:768px) {
            .form-row {
                grid-template-columns: 1fr
            }

            .stats-grid,
            .actions-grid {
                grid-template-columns: 1fr
            }

            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center
            }

            .container {
                padding: 12px
            }

            .office-selection {
                grid-template-columns: 1fr
            }

            .camera-controls {
                flex-direction: column;
                align-items: center
            }
        }
    </style>
</head>


<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-title">Employee Attendance System</div>
                <div class="login-subtitle">Sign in to mark your attendance</div>

                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="loginUsername" class="form-control" placeholder="Enter your username"
                            required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password"
                            required>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full-width" id="loginBtn">
                        <span id="loginBtnText">Sign In</span>
                        <span id="loginSpinner" class="loading-spinner hidden"></span>
                    </button>
                </form>

                <div class="signup-link">
                    <p>New employee? <a href="#" onclick="showScreen('signupScreen')">Sign up here</a></p>
                </div>

                <!-- <div class="demo-credentials">
                    <h4>Demo Credentials</h4>
                    <p><strong>Admin:</strong> admin / password</p>
                    <p><strong>Employee:</strong> john.doe / password</p>
                </div> -->
            </div>
        </div>
    </div>

    <!-- Signup Screen -->
    <div id="signupScreen" class="screen">
        <div class="login-container">
            <div class="login-card" style="max-width: 600px;">
                <div class="login-title">Create Your Account</div>
                <div class="login-subtitle">Join our attendance system</div>

                <form onsubmit="handleSignup(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" id="signupName" class="form-control" placeholder="Enter full name"
                                required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" id="signupPhone" class="form-control" placeholder="10-digit number"
                                required pattern="[0-9]{10}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="signupEmail" class="form-control" placeholder="Enter email" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Department</label>
                            <select id="signupDepartment" class="form-control" required>
                                <option value="">Select Department</option>
                                <option value="IT">IT</option>
                                <option value="HR">HR</option>
                                <option value="Surveyors">Surveyors</option>
                                <option value="Accounts">Accounts</option>
                                <option value="Growth">Growth</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Primary Office</label>
                            <select id="signupOffice" class="form-control" required>
                                <option value="">Select Office</option>
                                <option value="79">79 Office</option>
                                <option value="105">105 Office</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" id="signupUsername" class="form-control" placeholder="Choose username"
                                required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" id="signupPassword" class="form-control"
                                placeholder="Create password" required minlength="6">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full-width" id="signupBtn">
                        <span id="signupBtnText">Create Account</span>
                        <span id="signupSpinner" class="loading-spinner hidden"></span>
                    </button>
                </form>

                <div class="login-link">
                    <p>Already have an account? <a href="#" onclick="showScreen('loginScreen')">Sign in here</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="screen">
        <div class="container">
            <div class="header">
                <div class="header-title">Attendance Dashboard</div>
                <div class="header-user">
                    <span class="user-welcome">Welcome, <span id="userName">User</span></span>
                    <button onclick="logout()" class="btn btn-secondary">Logout</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-title">Today's Status</div>
                    <div class="stat-card-value" id="todayStatus">Not Marked</div>
                    <div class="stat-card-timing" id="todayTiming"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">This Month</div>
                    <div class="stat-card-value" id="monthlyDays">0</div>
                    <div class="stat-card-timing">Working Days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">WFH Used</div>
                    <div class="stat-card-value" id="wfhCount">0/1</div>
                    <div class="stat-card-timing">This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">Location Status</div>
                    <div class="stat-card-value" id="locationStatus">Checking...</div>
                    <div class="stat-card-timing" id="locationDistance"></div>
                </div>
            </div>

            <div class="actions-grid">
                <div class="action-card" onclick="startAttendanceFlow()" id="checkInCard">
                    <span class="action-card-icon">üìç</span>
                    <div class="action-card-title">Check In</div>
                    <div class="action-card-description">Mark your attendance with location and photo</div>
                </div>
                <div class="action-card hidden" onclick="showCheckOut()" id="checkOutCard">
                    <span class="action-card-icon">üèÉ</span>
                    <div class="action-card-title">Check Out</div>
                    <div class="action-card-description">Complete your work day</div>
                </div>
                <div class="action-card" onclick="showScreen('recordsScreen')">
                    <span class="action-card-icon">üìã</span>
                    <div class="action-card-title">My Records</div>
                    <div class="action-card-description">View your attendance history</div>
                </div>
                <div class="action-card hidden" onclick="openAdminPanel()" id="adminCard">
                    <span class="action-card-icon">‚úçÔ∏è</span>
                    <div class="action-card-title">Admin Panel</div>
                    <div class="action-card-description">Add/Edit Users/Offices (Admin only)</div>
                </div>
                <div class="action-card hidden" onclick="openProfile()" id="profileCard">
                    <span class="action-card-icon">üßë‚Äçüíª</span>
                    <div class="action-card-title">Edit Your Details</div>
                    <div class="action-card-description">Update your name, email, phone, password</div>
                </div>
                <div class="action-card" onclick="exportToExcel()" id="exportCard">
                    <span class="action-card-icon">üìä</span>
                    <div class="action-card-title">Export Attendance</div>
                    <div class="action-card-description">Download attendance records as Excel file (Admin only)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Screen (for employees) -->
    <div id="profileScreen" class="screen">
        <div class="container">
            <div class="header">
                <div class="header-title">Edit Your Details</div>
                <button onclick="showScreen('dashboardScreen')" class="btn btn-secondary">‚Üê Back</button>
            </div>

            <div class="card" style="max-width:700px; margin:0 auto;">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input id="profileName" class="form-control" placeholder="Your name">
                </div>

                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input id="profileEmail" class="form-control" placeholder="you@example.com">
                </div>

                <div class="form-group">
                    <label class="form-label">Mobile</label>
                    <input id="profilePhone" class="form-control" placeholder="10-digit number">
                </div>

                <div class="form-group">
                    <label class="form-label">Department</label>
                    <input id="profileDepartment" class="form-control" disabled>
                </div>

                <div class="form-group">
                    <label class="form-label">Change Password (optional)</label>
                    <input id="profilePassword" type="password" class="form-control"
                        placeholder="Leave blank to keep current">
                </div>

                <div class="text-center" style="margin-top:12px;">
                    <button class="btn btn-primary" onclick="saveProfile()">
                        <span id="profileSaveText">Save Changes</span>
                        <span id="profileSaveSpinner" class="loading-spinner hidden"></span>
                    </button>
                </div>
                <div id="profileMsg" style="margin-top:8px;color:var(--gray-700);font-size:13px;"></div>
            </div>
        </div>
    </div>


    <!-- Attendance Screen -->
    <div id="attendanceScreen" class="screen">
        <div class="container">
            <div class="header">
                <div class="header-title">Mark Attendance</div>
                <button onclick="showScreen('dashboardScreen')" class="btn btn-secondary">‚Üê Back</button>
            </div>

            <div class="card">
                <!-- Choice row: WFH / Office / Client -->
                <div id="typeSelectionSection" style="margin-top: 8px;">
                    <h3>Select Attendance Type:</h3>
                    <div class="office-selection" id="typeSelection">
                        <!-- inside the WFH card -->
                        <div class="office-card" onclick="onWFHCardClick(event)" id="wfhOption">

                            <span class="action-card-icon">üè†</span>
                            <h3>Work From Home</h3>
                            <p id="wfhStatus">Checking availability...</p>

                            <!-- add this line -->
                            <button id="wfhRequestBtn" class="btn btn-secondary"
                                style="display:none; margin-top:8px; background-color: #1d4ed8;"
                                onclick="requestWFHExtension(event)">Request WFH</button>
                        </div>


                        <div class="office-card" onclick="selectType('office', event)">
                            <span class="action-card-icon">üè¢</span>
                            <h3>Office Work</h3>
                            <p>Shows offices after you tap</p>
                        </div>

                        <div class="office-card" onclick="selectType('client', event)">
                            <span class="action-card-icon">üìç</span>
                            <h3>Client Location</h3>
                            <p>No geofence required</p>
                        </div>
                    </div>
                </div>

                <!-- Offices (hidden until user picks ‚ÄúOffice Work‚Äù) -->
                <div id="officeBlock" style="display:none; margin-top: 24px;">
                    <h3>Select Office:</h3>
                    <p style="color: var(--gray-500); margin-bottom: 12px;">
                        Only offices within range will be enabled
                    </p>
                    <div class="office-selection" id="officeSelection">
                        <!-- populated by JS -->
                    </div>
                </div>

                <!-- Camera -->
                <div id="cameraSection" class="hidden" style="margin-top: 24px;">
                    <h3>Take Your Photo:</h3>
                    <p style="color: var(--gray-500); margin-bottom: 12px;">Photo is required for verification</p>

                    <div class="camera-container">
                        <video id="video" autoplay muted playsinline style="display:none;"></video>
                        <img id="capturedPhoto" style="display:none;">
                        <div id="cameraPlaceholder"
                            style="display:flex;align-items:center;justify-content:center;height:100%;background:#f3f4f6;color:#6b7280;">
                            Click "Start Camera" to begin
                        </div>
                    </div>

                    <div class="camera-controls">
                        <button onclick="startCamera()" class="btn btn-primary" id="startCameraBtn">üì∑ Start
                            Camera</button>
                        <button onclick="capturePhoto()" class="btn btn-success" id="captureBtn"
                            style="display:none;">üì∏ Capture</button>
                        <button onclick="retakePhoto()" class="btn btn-secondary" id="retakeBtn"
                            style="display:none;">üîÑ Retake</button>
                    </div>

                    <div class="text-center" style="margin-top: 16px;">
                        <button onclick="markAttendance()" class="btn btn-success" id="markBtn" style="display:none;">
                            <span id="markBtnText">‚úÖ Mark Attendance</span>
                            <span id="markSpinner" class="loading-spinner hidden"></span>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Records Screen -->
    <div id="recordsScreen" class="screen">
        <div class="container">
            <div class="header">
                <div class="header-title">Attendance Records</div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <span id="adminExportNote" class="hidden" style="color: var(--gray-500); font-size: 14px;">(Admin:
                        Export available)</span>
                    <button onclick="showScreen('dashboardScreen')" class="btn btn-secondary">‚Üê Back</button>
                </div>
            </div>

            <div class="card">
                <div id="recordsContent">
                    <div class="text-center" style="padding: 40px;">
                        <div class="loading-spinner" style="margin: 0 auto 16px; width: 24px; height: 24px;"></div>
                        <p>Loading attendance records...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Admin Panel -->
    <div id="adminScreen" class="screen">
        <div class="container">
            <div class="header">
                <div class="header-title">Admin Panel</div>
                <div style="display:flex; gap:12px; align-items:center;">
                    <button onclick="showScreen('dashboardScreen')" class="btn btn-secondary">‚Üê Back</button>
                </div>
            </div>

            <div class="admin-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                <!-- Add Office -->
                <div class="card">
                    <h3 style="margin-bottom:12px;">Add New Office</h3>
                    <div class="form-group">
                        <label class="form-label">Office Name</label>
                        <input id="newOfficeName" class="form-control" placeholder="e.g., Head Office">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input id="newOfficeAddress" class="form-control" placeholder="Office address">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Latitude</label>
                            <input id="newOfficeLat" class="form-control" placeholder="e.g., 28.6139">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Longitude</label>
                            <input id="newOfficeLng" class="form-control" placeholder="e.g., 77.2090">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Radius (meters)</label>
                        <input id="newOfficeRadius" class="form-control" placeholder="e.g., 100">
                    </div>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <button class="btn btn-primary" onclick="submitNewOffice()">‚ûï Add Office</button>
                        <button class="btn" onclick="clearOfficeForm()">Reset</button>
                    </div>
                    <div id="addOfficeMsg" style="margin-top:8px;color:var(--gray-700);font-size:13px;"></div>
                </div>

                <!-- Add User -->
                <div class="card">
                    <h3 style="margin-bottom:12px;">Add New User</h3>
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input id="newUserName" class="form-control" placeholder="e.g., John Doe">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input id="newUserUsername" class="form-control" placeholder="username">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mobile Number</label>
                            <input id="newUserPhone" class="form-control" placeholder="10-digit number">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input id="newUserEmail" class="form-control" placeholder="email@example.com">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Department</label>
                            <select id="newUserDepartment" class="form-control">
                                <option value="">Select Department</option>
                                <option>IT</option>
                                <option>HR</option>
                                <option>Surveyors</option>
                                <option>Accounts</option>
                                <option>Growth</option>
                                <option>Others</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Primary Office</label>
                            <select id="newUserPrimaryOffice" class="form-control">
                                <option value="">Loading offices‚Ä¶</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Role</label>
                            <select id="newUserRole" class="form-control">
                                <option value="employee">Employee</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input id="newUserPassword" type="password" class="form-control" placeholder="min 6 chars">
                        </div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-success" onclick="submitNewUser()">‚ûï Add User</button>
                        <button class="btn" onclick="clearUserForm()">Reset</button>
                    </div>
                    <div id="addUserMsg" style="margin-top:8px;color:var(--gray-700);font-size:13px;"></div>
                </div>
            </div>

            <!-- Lists -->
            <div style="display:grid; grid-template-columns:1fr; gap:20px; width: auto">
                <div class="card">
                    <h3>Offices <small id="officeCount" style="color:var(--gray-500); font-size:10px;"></small></h3>
                    <div id="adminOfficesList" style="margin-top:12px;"></div>
                </div>

                <div class="card">
                    <h3>Users Management <small id="userCount" style="color:var(--gray-500); font-size:10px;"></small>
                    </h3>
                    <div class="table-wrap" id="adminUsersListWrapper"
                        style="margin-top:12px;max-height:420px;overflow:auto;">
                        <table id="adminUsersTable" class="records-table">
                            <thead>
                                <tr>
                                    <th style="width:60px">ID</th>
                                    <th>Name</th>
                                    <th>Username</th>
                                    <th>Mobile</th>
                                    <th>Department</th>
                                    <th>Role</th>
                                    <th style="width:160px">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminUsersList"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="text-center">
                <div style="font-size: 64px; margin-bottom: 16px;">‚úÖ</div>
                <h3 style="margin-bottom: 16px;">Success!</h3>
                <p id="successMessage" style="margin-bottom: 24px;">Operation completed successfully.</p>
                <button onclick="closeModal('successModal')" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Check Out Confirmation Modal -->
    <div id="checkOutModal" class="modal">
        <div class="modal-content">
            <div class="text-center">
                <div style="font-size: 48px; margin-bottom: 16px;">üèÉ</div>
                <h3 style="margin-bottom: 16px;">Check Out Confirmation</h3>
                <div id="checkOutDetails" style="margin-bottom: 24px; text-align: left;"></div>
                <div id="halfDayWarning" class="hidden"
                    style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 20px; color: #92400e;">
                    <h4>‚ö†Ô∏è Half Day Warning</h4>
                    <p>You have worked less than 8 hours. This will be marked as a half day.</p>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button onclick="closeModal('checkOutModal')" class="btn btn-secondary">Cancel</button>
                    <button onclick="confirmCheckOut()" class="btn btn-primary" id="confirmCheckOutBtn">
                        <span id="checkOutBtnText">Confirm Check Out</span>
                        <span id="checkOutSpinner" class="loading-spinner hidden"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Global Variables
        let currentUser = null;
        let selectedOffice = null;
        let selectedType = null;
        let capturedPhotoData = null;
        let stream = null;
        let accessibleOffices = [];
        let editingUserId = null;
        let adminUserEditId = null;

        // API Configuration
        const apiBaseUrl = "./api.php";

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function () {
            console.log('MySQL Attendance System Initializing...');
            refreshPrimaryOfficeSelects();
            // Check for stored user session
            const storedUser = localStorage.getItem('attendanceUser');
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    showScreen('dashboardScreen');
                    loadDashboardData();
                } catch (e) {
                    localStorage.removeItem('attendanceUser');
                }
            }
        });
        function openModal(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.remove('active');
            document.body.style.overflow = '';
        }

        // optional: click backdrop to close
        document.addEventListener('click', (e) => {
            const modal = e.target.closest('.modal');
            if (modal && e.target === modal) closeModal(modal.id);
        });

        // optional: ESC key closes active modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(m => closeModal(m.id));
            }
        });

        // Utility Functions
        function resetAttendanceFlow() {
            // clear selections/state
            selectedOffice = null;
            selectedType = null;
            capturedPhotoData = null;

            // stop any running camera stream
            try {
                if (stream) {
                    stream.getTracks().forEach(t => t.stop());
                    stream = null;
                }
            } catch { }

            // reset camera UI
            const video = document.getElementById('video');
            const img = document.getElementById('capturedPhoto');
            const placeholder = document.getElementById('cameraPlaceholder');

            if (video) { video.srcObject = null; video.style.display = 'none'; }
            if (img) { img.src = ''; img.style.display = 'none'; }
            if (placeholder) { placeholder.style.display = 'flex'; }

            const startBtn = document.getElementById('startCameraBtn');
            const captureBtn = document.getElementById('captureBtn');
            const retakeBtn = document.getElementById('retakeBtn');
            const markBtn = document.getElementById('markBtn');

            if (startBtn) startBtn.style.display = 'inline-block';
            if (captureBtn) captureBtn.style.display = 'none';
            if (retakeBtn) retakeBtn.style.display = 'none';
            if (markBtn) markBtn.style.display = 'none';

            // reset cards selection
            document.querySelectorAll('#typeSelection .office-card, #officeSelection .office-card')
                .forEach(el => el.classList.remove('selected'));

            // show type choices, hide office list & camera until a type is picked
            const typeSection = document.getElementById('typeSelectionSection');
            const officeBlock = document.getElementById('officeBlock');
            const cameraSection = document.getElementById('cameraSection');

            if (typeSection) typeSection.classList.remove('hidden');
            if (officeBlock) officeBlock.style.display = 'none';
            if (cameraSection) cameraSection.classList.add('hidden');
        }

        function showScreen(screenId) {
            // Prevent non-admins from opening adminScreen
            if (screenId === 'adminScreen' && (!currentUser || currentUser.role !== 'admin')) {
                showNotification('Admins only.', 'warning');
                screenId = 'dashboardScreen';
            }

            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            if (screenId === 'recordsScreen') {
                loadAttendanceRecords();
            } else if (screenId === 'attendanceScreen') {
                // avoid reference error if you removed resetAttendanceFlow
                if (typeof resetAttendanceFlow === 'function') resetAttendanceFlow();
            }
        }


        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => notification.classList.remove('show'), 4000);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatTime(date) {
            return date.toTimeString().split(' ')[0];
        }

        function getCurrentDateTime() {
            const now = new Date();
            return {
                date: formatDate(now),
                time: formatTime(now)
            };
        }

        // Haversine distance in METERS
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const toRad = (v) => (v * Math.PI) / 180;
            const R = 6371000; // Earth radius (m)

            const dLat = toRad(lat2 - lat1);
            const dLng = toRad(lng2 - lng1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }


        // API Functions
        // Robust apiCall: uses query-style endpoint: /api.php?endpoint=attendance-records
        async function apiCall(path, method = 'GET', data = null) {
            method = (method || 'GET').toUpperCase();
            let url = apiBaseUrl + '?endpoint=' + encodeURI(path);

            if (method === 'GET' && data && typeof data === 'object') {
                const qs = Object.keys(data).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(data[k])).join('&');
                if (qs) url += '&' + qs;
            }

            const opts = { method, headers: {} };
            // üëá add both lines
            opts.cache = 'no-store';
            opts.headers['Cache-Control'] = 'no-cache';

            if (method !== 'GET' && data !== null) {
                opts.headers['Content-Type'] = 'application/json';
                opts.body = JSON.stringify(data);
            }

            const res = await fetch(url, opts);
            const text = await res.text();
            try { return JSON.parse(text); } catch { return { success: false, raw: text, status: res.status }; }
        }



        // Authentication Functions
        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginSpinner = document.getElementById('loginSpinner');

            if (!username || !password) {
                showNotification('Please enter username and password', 'error');
                return;
            }

            // Show loading state
            loginBtn.disabled = true;
            loginBtnText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');

            try {
                const result = await apiCall('login', 'POST', {
                    username: username,
                    password: password
                });

                if (result.success) {
                    currentUser = result.user;
                    localStorage.setItem('attendanceUser', JSON.stringify(currentUser));

                    showNotification('Login successful!');
                    showScreen('dashboardScreen');
                    await loadDashboardData();
                    await populateOfficeDropdowns();
                } else {
                    showNotification(result.message || 'Login failed', 'error');
                }
            } finally {
                // Reset button state
                loginBtn.disabled = false;
                loginBtnText.classList.remove('hidden');
                loginSpinner.classList.add('hidden');
            }
        }

        async function handleSignup(event) {
            event.preventDefault();

            const formData = {
                name: document.getElementById('signupName').value,
                phone: document.getElementById('signupPhone').value,
                email: document.getElementById('signupEmail').value,
                department: document.getElementById('signupDepartment').value,
                primary_office: document.getElementById('signupOffice').value,
                username: document.getElementById('signupUsername').value,
                password: document.getElementById('signupPassword').value
            };

            const signupBtn = document.getElementById('signupBtn');
            const signupBtnText = document.getElementById('signupBtnText');
            const signupSpinner = document.getElementById('signupSpinner');

            // Show loading state
            signupBtn.disabled = true;
            signupBtnText.classList.add('hidden');
            signupSpinner.classList.remove('hidden');

            try {
                const result = await apiCall('register', 'POST', formData);

                if (result.success) {
                    showNotification('Account created successfully! Please login.');
                    showScreen('loginScreen');

                    // Clear form
                    Object.keys(formData).forEach(key => {
                        const element = document.getElementById(`signup${key.charAt(0).toUpperCase()}${key.slice(1).replace('_', '')}`);
                        if (element) element.value = '';
                    });
                } else {
                    showNotification(result.message || 'Registration failed', 'error');
                }
            } finally {
                // Reset button state
                signupBtn.disabled = false;
                signupBtnText.classList.remove('hidden');
                signupSpinner.classList.add('hidden');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('attendanceUser');
            showNotification('Logged out successfully');
            showScreen('loginScreen');
        }

        // Dashboard Functions
        async function loadDashboardData() {
            if (!currentUser) return;

            document.getElementById('userName').textContent = currentUser.name;

            if (currentUser.role === 'admin') {
                // Admin sees Admin panel card + Export
                document.getElementById('adminCard').classList.remove('hidden');
                document.getElementById('exportCard').classList.remove('hidden');
                document.getElementById('profileCard').classList.add('hidden');
                document.getElementById('adminExportNote')?.classList.remove('hidden');
            } else {
                // Employee sees Profile card; Admin panel + Export hidden
                document.getElementById('profileCard').classList.remove('hidden');
                document.getElementById('adminCard').classList.add('hidden');
                document.getElementById('exportCard').classList.add('hidden');
                document.getElementById('adminExportNote')?.classList.add('hidden');
            }

            await Promise.all([
                loadTodayAttendance(),
                loadMonthlyStats(),
                loadWFHEligibility(),
                updateLocationStatus()
            ]);
        }


        async function loadTodayAttendance() {
            try {
                const result = await apiCall('today-attendance', 'GET', {
                    employee_id: currentUser.id
                });

                const statusElement = document.getElementById('todayStatus');
                const timingElement = document.getElementById('todayTiming');
                const checkInCard = document.getElementById('checkInCard');
                const checkOutCard = document.getElementById('checkOutCard');

                if (result.success && result.record) {
                    const record = result.record;

                    if (record.check_out_time) {
                        statusElement.textContent = 'Completed';
                        statusElement.className = 'stat-card-value success';
                        timingElement.textContent = `${record.check_in_time} - ${record.check_out_time}`;
                        checkInCard.classList.add('hidden');
                        checkOutCard.classList.add('hidden');
                    } else {
                        statusElement.textContent = 'Checked In';
                        statusElement.className = 'stat-card-value success';
                        timingElement.textContent = `Since ${record.check_in_time}`;
                        checkInCard.classList.add('hidden');
                        checkOutCard.classList.remove('hidden');
                    }
                } else {
                    statusElement.textContent = 'Not Marked';
                    statusElement.className = 'stat-card-value error';
                    timingElement.textContent = '';
                    checkInCard.classList.remove('hidden');
                    checkOutCard.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading today attendance:', error);
            }
        }

        async function loadMonthlyStats() {
            try {
                const result = await apiCall('monthly-stats', 'GET', {
                    employee_id: currentUser.id
                });

                const monthlyDaysElement = document.getElementById('monthlyDays');
                if (result.success && result.stats) {
                    monthlyDaysElement.textContent = result.stats.total_days || 0;
                }
            } catch (error) {
                console.error('Error loading monthly stats:', error);
            }
        }

        async function loadWFHEligibility() {
            try {
                const result = await apiCall('wfh-eligibility', 'GET', {
                    employee_id: currentUser.id,
                    date: getCurrentDateTime().date
                });

                const wfhCountElement = document.getElementById('wfhCount');
                if (result) {
                    const currentCount = result.current_count || 0;
                    const maxLimit = result.max_limit || 1;

                    wfhCountElement.textContent = `${currentCount}/${maxLimit}`;

                    if (currentCount >= maxLimit) {
                        wfhCountElement.className = 'stat-card-value warning';
                    } else {
                        wfhCountElement.className = 'stat-card-value success';
                    }
                }
            } catch (error) {
                console.error('Error loading WFH eligibility:', error);
            }
        }

        async function updateLocationStatus() {
            if (typeof checkAndUpdateLocationStatus === 'function') {
                return await checkAndUpdateLocationStatus();
            }
            return null;
        }


        // Computes "Location Status" on the dashboard and updates the UI
        async function checkAndUpdateLocationStatus() {
            const statusEl = document.getElementById('locationStatus');
            const distEl = document.getElementById('locationDistance');

            // Helper to render a retry link
            const showRetry = (msg, css = 'warning') => {
                statusEl.textContent = msg;
                statusEl.className = 'stat-card-value ' + css;
                distEl.innerHTML = `<a href="#" id="retryGeo" style="text-decoration:underline;">Retry location</a>`;
                const a = document.getElementById('retryGeo');
                if (a) a.onclick = (e) => { e.preventDefault(); checkAndUpdateLocationStatus(); };
            };

            // Start state
            statusEl.textContent = 'Checking...';
            statusEl.className = 'stat-card-value';
            distEl.textContent = '';

            // 1) Load offices (so we can compute distance)
            let offices = [];
            try {
                const res = await apiCall('offices', 'GET', { active: 1, department: currentUser.department });
                offices = (res && res.success && Array.isArray(res.offices)) ? res.offices : [];
            } catch { }
            if (offices.length === 0) {
                statusEl.textContent = 'No offices';
                statusEl.className = 'stat-card-value warning';
                distEl.textContent = '';
                return;
            }

            // 2) Geolocation capability?
            if (!('geolocation' in navigator)) {
                showRetry('Location unavailable in this browser', 'warning');
                distEl.textContent = 'Use localhost/https and allow location';
                return;
            }

            // 3) Try to get position with good timeouts
            try {
                const pos = await new Promise((resolve, reject) => {
                    let settled = false;
                    const guard = setTimeout(() => { if (!settled) { settled = true; reject(Object.assign(new Error('timeout'), { code: 3 })); } }, 8000);
                    navigator.geolocation.getCurrentPosition(
                        (p) => { if (!settled) { settled = true; clearTimeout(guard); resolve(p); } },
                        (err) => { if (!settled) { settled = true; clearTimeout(guard); reject(err); } },
                        { enableHighAccuracy: true, timeout: 7000, maximumAge: 60000 }
                    );
                });

                const { latitude: lat, longitude: lng } = pos.coords;

                // 4) Compute nearest office
                let nearest = { d: Infinity, office: null };
                for (const o of offices) {
                    const d = calculateDistance(lat, lng, parseFloat(o.latitude), parseFloat(o.longitude));
                    if (d < nearest.d) nearest = { d, office: o };
                }

                if (!nearest.office) {
                    statusEl.textContent = 'No offices';
                    statusEl.className = 'stat-card-value warning';
                    distEl.textContent = '';
                    return;
                }

                const inRange = nearest.d <= (nearest.office.radius_meters || 0);
                statusEl.textContent = inRange ? 'In Office Range' : 'Out of Range';
                statusEl.className = 'stat-card-value ' + (inRange ? 'success' : 'warning');
                distEl.textContent = `${nearest.office.name} ‚Ä¢ ${Math.round(nearest.d)} m`;
            } catch (err) {
                // Differentiate errors
                if (err && err.code === 1) {            // PERMISSION_DENIED
                    showRetry('Location permission denied', 'error');
                    distEl.textContent = 'Allow location for this site, then retry';
                } else if (err && err.code === 2) {     // POSITION_UNAVAILABLE
                    showRetry('Location unavailable', 'warning');
                    distEl.textContent = 'Try moving or check GPS/network';
                } else if (err && err.code === 3) {     // TIMEOUT
                    showRetry('Location timed out', 'warning');
                    distEl.textContent = 'Retry; go near a window';
                } else {
                    showRetry('Location error', 'warning');
                    distEl.textContent = 'Retry or check permissions';
                }
            }
        }

        /* ===== renderOfficeCards ===== */
        async function renderOfficeCards(userLat, userLng) {
            const container = document.getElementById('officeSelection');
            container.innerHTML = '';

            for (const office of accessibleOffices) {
                const distance = (typeof userLat === 'number' && typeof userLng === 'number')
                    ? calculateDistance(userLat, userLng, parseFloat(office.latitude), parseFloat(office.longitude))
                    : null;

                const inRange = distance !== null ? (distance <= office.radius_meters) : false;
                // Visual class still indicates disabled, but card remains clickable.
                const cardClass = 'office-card' + (inRange ? '' : ''); // remove 'disabled' so it's clickable

                const officeCard = document.createElement('div');
                officeCard.className = cardClass;
                officeCard.innerHTML = `
            <span class="action-card-icon">üè¢</span>
            <h3>${office.name}</h3>
            <p>${office.address || ''}</p>
            <div class="location-status ${inRange ? 'in-range' : 'out-of-range'}">
                ${inRange ? 'In Range' : 'Out of Range'}${distance !== null ? ` (${Math.round(distance)}m)` : ''}
            </div>
        `;

                // Always attach onclick so user can choose any office (even out-of-range).
                officeCard.onclick = (e) => selectOffice(e, office.id);

                container.appendChild(officeCard);
            }

            // Also ensure the WFH option is updated (keeps eligibility logic separate)
            await updateWFHOption();
        }

        /* ===== renderOfficeCardsWithoutLocation ===== */
        function renderOfficeCardsWithoutLocation() {
            const container = document.getElementById('officeSelection');
            container.innerHTML = '';

            accessibleOffices.forEach(office => {
                const officeCard = document.createElement('div');
                officeCard.className = 'office-card';
                officeCard.innerHTML = `
            <span class="action-card-icon">üè¢</span>
            <h3>${office.name}</h3>
            <p>${office.address || ''}</p>
            <div class="location-status checking">Location check unavailable</div>
        `;

                // Still allow selecting an office even when location is unavailable.
                officeCard.onclick = (e) => selectOffice(e, office.id);
                container.appendChild(officeCard);
            });

            // Update WFH option as well
            updateWFHOption().catch(err => console.error(err));
        }

        /* ===== selectOffice =====
           Accept event explicitly (to safely use event.target), and always show type selection.
        */
        async function selectOffice(e, officeId) {
            // store chosen office (can be out-of-range); for WFH user may later choose WFH which will set selectedOffice to null
            selectedOffice = officeId;

            // Update UI selection highlight
            document.querySelectorAll('#officeSelection .office-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Find the clicked card element robustly
            let cardEl = e.target;
            // climb up to the office-card container
            while (cardEl && !cardEl.classList.contains('office-card')) {
                cardEl = cardEl.parentElement;
            }
            if (cardEl) cardEl.classList.add('selected');

            // Show type selection regardless of range ‚Äî user can pick WFH (which sets selectedOffice = null)
            document.getElementById('typeSelectionSection').classList.remove('hidden');

            // Refresh WFH eligibility text/button (limit-based)
            await updateWFHOption();
        }

        /* ===== selectType =====
           Accept event explicitly; allow WFH without an office (selectedOffice will be null for WFH).
        */
        function selectType(type, e) {
            // If WFH is selected and the WFH option shows disabled (limit reached), prevent selection
            if (type === 'wfh') {
                const wfhOption = document.getElementById('wfhOption');
                if (wfhOption.classList.contains('disabled')) {
                    return;
                }
                // For WFH clear selectedOffice (office_id will be null in attendance payload)
                selectedOffice = null;
            }

            selectedType = type;

            // Update UI selection highlight for types
            document.querySelectorAll('#typeSelection .office-card').forEach(card => {
                card.classList.remove('selected');
            });

            // get the clicked card element and mark it selected
            let cardEl = e ? e.target : null;
            if (cardEl) {
                while (cardEl && !cardEl.classList.contains('office-card')) {
                    cardEl = cardEl.parentElement;
                }
                if (cardEl) cardEl.classList.add('selected');
            }

            // Show camera section
            document.getElementById('cameraSection').classList.remove('hidden');
        }


        // Attendance Flow Functions
        // ===== Attendance & Camera: CLEAN CONSOLIDATED BLOCK =====

        // Globals expected: currentUser, selectedOffice, selectedType, capturedPhotoData, stream, accessibleOffices

        /* Entry point when user clicks ‚ÄúCheck In‚Äù */
        async function startAttendanceFlow() {
            showScreen('attendanceScreen');
            if (typeof resetAttendanceFlow === 'function') resetAttendanceFlow();

            accessibleOffices = [];

            // show three choices first
            document.getElementById('typeSelectionSection').classList.remove('hidden');
            const officeBlock = document.getElementById('officeBlock');
            if (officeBlock) officeBlock.style.display = 'none';
            document.getElementById('cameraSection').classList.add('hidden');

            await refreshWFHAvailability();
        }

        /* ---------------- WFH availability: no more ‚Äústuck checking‚Äù ---------------- */

        async function refreshWFHAvailability() {
            const wfhOption = document.getElementById('wfhOption');
            const wfhStatus = document.getElementById('wfhStatus');
            const requestBtn = document.getElementById('wfhRequestBtn');

            // Always start from a determinate UI state
            wfhStatus.textContent = 'Checking availability...';
            wfhStatus.style.color = 'var(--gray-600)';
            wfhOption.classList.remove('disabled');
            if (requestBtn) requestBtn.style.display = 'none';

            // ---------- 1) Get offices (for geofence check) ----------
            let offices = [];
            try {
                const res = await apiCall('offices', 'GET', { active: 1, department: currentUser.department });
                offices = (res && res.success && Array.isArray(res.offices)) ? res.offices : [];
            } catch (e) {
                // ignore; we‚Äôll proceed with unknown geofence
            }

            // ---------- 2) Check geofence with a timeout (never hang) ----------
            let inAnyOffice = false;    // default
            let geoChecked = false;

            if (navigator.geolocation && offices.length > 0) {
                try {
                    const pos = await new Promise((resolve, reject) => {
                        let settled = false;
                        const guard = setTimeout(() => { if (!settled) { settled = true; reject(new Error('timeout')); } }, 5000);
                        navigator.geolocation.getCurrentPosition(
                            (p) => { if (!settled) { settled = true; clearTimeout(guard); resolve(p); } },
                            (e) => { if (!settled) { settled = true; clearTimeout(guard); reject(e); } },
                            { enableHighAccuracy: false, timeout: 4500, maximumAge: 60000 }
                        );
                    });
                    const { latitude, longitude } = pos.coords;
                    for (const o of offices) {
                        const d = calculateDistance(latitude, longitude, parseFloat(o.latitude), parseFloat(o.longitude));
                        if (d <= (o.radius_meters || 0)) { inAnyOffice = true; break; }
                    }
                    geoChecked = true;
                } catch {
                    geoChecked = false; // user denied or timeout ‚Üí treat as unknown but do not block
                }
            }

            // Apply geofence result now (so UI updates even if server call fails)
            if (geoChecked && inAnyOffice) {
                // inside office ‚Üí WFH disabled regardless of monthly limit
                wfhOption.classList.add('disabled');
                wfhStatus.textContent = 'WFH not allowed while at office';
                wfhStatus.style.color = 'var(--error-color)';
                if (requestBtn) requestBtn.style.display = 'none';
                return; // we can stop here (limit doesn‚Äôt matter when inside office)
            } else if (!geoChecked) {
                // location unknown ‚Üí allow WFH but label appropriately
                wfhOption.classList.remove('disabled');
                wfhStatus.textContent = 'Availability unknown (no location)';
                wfhStatus.style.color = 'var(--warning-color)';
            } else {
                // outside any office ‚Üí tentatively available, refine with server limit next
                wfhOption.classList.remove('disabled');
                wfhStatus.textContent = 'Checking monthly limit...';
                wfhStatus.style.color = 'var(--gray-600)';
            }

            // ---------- 3) Check monthly WFH limit from server ----------
            try {
                const today = getCurrentDateTime().date;
                const r = await apiCall('wfh-eligibility', 'GET', { employee_id: currentUser.id, date: today });

                // Expected shape: { current_count, max_limit, can_request }
                if (r && typeof r.current_count === 'number' && typeof r.max_limit !== 'undefined') {
                    if (r.current_count >= r.max_limit || r.can_request === false) {
                        // limit reached ‚Üí show request button
                        wfhStatus.textContent = `Limit reached (${r.current_count}/${r.max_limit})`;
                        wfhStatus.style.color = 'var(--error-color)';
                        if (!wfhOption.classList.contains('disabled')) wfhOption.classList.add('disabled'); // keep it disabled
                        if (requestBtn) requestBtn.style.display = 'inline-flex';
                        return;
                    } else {
                        // still has quota
                        wfhStatus.textContent = `Available (${r.current_count}/${r.max_limit})`;
                        wfhStatus.style.color = 'var(--success-color)';
                        if (requestBtn) requestBtn.style.display = 'none';
                        return;
                    }
                }

                // If server didn‚Äôt return expected shape, fall back to available
                wfhStatus.textContent = 'Available';
                wfhStatus.style.color = 'var(--success-color)';
            } catch {
                // Server error ‚Üí keep it available, don‚Äôt hang
                wfhStatus.textContent = 'Available (limit unknown)';
                wfhStatus.style.color = 'var(--success-color)';
            }
        }

        /* Tapping the WFH card rechecks availability (and can reveal the Request button immediately) */
        function onWFHCardClick(e) {
            e && e.stopPropagation && e.stopPropagation();
            // If it looks disabled already (inside geofence), show a message and do nothing.
            const wfhOption = document.getElementById('wfhOption');
            if (wfhOption.classList.contains('disabled')) {
                showNotification('WFH not available right now.', 'warning');
                return;
            }
            // Refresh once more (fast) so the Request button can appear if quota just reached.
            refreshWFHAvailability().then(() => {
                // If still enabled after refresh, proceed to select type and open camera.
                const disabled = document.getElementById('wfhOption').classList.contains('disabled');
                if (!disabled) selectType('wfh', e);
            });
        }

        /* Request WFH fallback (API first, mailto fallback) */
        async function requestWFHExtension(ev) {
            ev && ev.stopPropagation && ev.stopPropagation();
            const note = prompt('Add a short note for Admin/HR (optional):', '');
            if (note === null) return;

            try {
                const res = await apiCall('wfh-request', 'POST', {
                    employee_id: currentUser.id,
                    date: getCurrentDateTime().date,
                    reason: note
                });
                if (res && res.success) {
                    showNotification('WFH request sent to Admin/HR', 'success');
                    return;
                }
            } catch { }

            // No API? Fall back to email:
            const mailto = `mailto:pet.health2023@gmail.com?subject=WFH%20Request&body=${encodeURIComponent(
                `Employee: ${currentUser.name} (#${currentUser.id})%0D%0ADate: ${getCurrentDateTime().date}%0D%0AReason: ${note}`
            )}`;
            window.location.href = mailto;
            showNotification('Opening your mail app to send the request.');
        }


        /* When user taps WFH / Office / Client */
        function selectType(type, e) {
            // block if WFH disabled (inside geofence)
            if (type === 'wfh' && document.getElementById('wfhOption').classList.contains('disabled')) {
                showNotification('You are within an office geofence. WFH is not allowed.', 'warning');
                return;
            }
            selectedType = type;

            // highlight the chosen card
            document.querySelectorAll('#typeSelection .office-card').forEach(c => c.classList.remove('selected'));
            if (e && e.target) {
                let el = e.target;
                while (el && !el.classList.contains('office-card')) el = el.parentElement;
                if (el) el.classList.add('selected');
            }

            if (type === 'office') {
                document.getElementById('officeBlock').style.display = 'grid';
                loadOfficeSelection();
                document.getElementById('cameraSection').classList.add('hidden');
            } else {
                // WFH / Client -> no office list
                selectedOffice = null;
                document.getElementById('officeBlock').style.display = 'none';
                document.getElementById('cameraSection').classList.remove('hidden');
            }
        }

        /* Build office cards (called only after user picks Office Work) */
        async function loadOfficeSelection() {
            const container = document.getElementById('officeSelection');
            container.innerHTML = '<div class="text-center" style="padding:16px;">Loading offices‚Ä¶</div>';

            // Always refetch ‚Äì do not rely on cached accessibleOffices
            const res = await apiCall('offices', 'GET', {
                active: 1,
                department: currentUser.department
            });
            accessibleOffices = (res && res.success) ? (res.offices || []) : [];

            if (accessibleOffices.length === 0) {
                container.innerHTML = '<p style="color:var(--gray-600)">No offices found.</p>';
                return;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => renderOfficeCards(pos.coords.latitude, pos.coords.longitude),
                    () => renderOfficeCardsWithoutLocation(),
                    { timeout: 6000 }
                );
            } else {
                renderOfficeCardsWithoutLocation();
            }
        }

        function renderOfficeCards(userLat, userLng) {
            const container = document.getElementById('officeSelection');
            container.innerHTML = '';

            for (const o of accessibleOffices) {
                const d = calculateDistance(userLat, userLng, parseFloat(o.latitude), parseFloat(o.longitude));
                const inRange = d <= (o.radius_meters || 0);

                const card = document.createElement('div');
                card.className = 'office-card' + (inRange ? '' : ' disabled');
                card.innerHTML = `
      <span class="action-card-icon">üè¢</span>
      <h3>${o.name}</h3>
      <p>${o.address || ''}</p>
      <div class="location-status ${inRange ? 'in-range' : 'out-of-range'}">
        ${inRange ? 'In Range' : 'Out of Range'} (${Math.round(d)}m)
      </div>
    `;
                card.onclick = inRange
                    ? (ev) => selectOffice(ev, o.id)
                    : () => showNotification('You are not within this office geofence', 'warning');

                container.appendChild(card);
            }
        }

        function renderOfficeCardsWithoutLocation() {
            const container = document.getElementById('officeSelection');
            container.innerHTML = '';
            for (const o of accessibleOffices) {
                const card = document.createElement('div');
                card.className = 'office-card';
                card.innerHTML = `
      <span class="action-card-icon">üè¢</span>
      <h3>${o.name}</h3>
      <p>${o.address || ''}</p>
      <div class="location-status checking">Location check unavailable</div>
    `;
                card.onclick = (ev) => selectOffice(ev, o.id);
                container.appendChild(card);
            }
        }

        function selectOffice(e, officeId) {
            selectedOffice = officeId;
            document.querySelectorAll('#officeSelection .office-card').forEach(c => c.classList.remove('selected'));
            let el = e.target;
            while (el && !el.classList.contains('office-card')) el = el.parentElement;
            if (el) el.classList.add('selected');

            // after choosing an office, show camera
            document.getElementById('cameraSection').classList.remove('hidden');
        }

        /* Camera (robust) */
        function startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification('Camera not supported on this device', 'error');
                return;
            }
            navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
                audio: false
            }).then(mediaStream => {
                stream = mediaStream;
                const video = document.getElementById('video');
                video.srcObject = mediaStream;
                video.style.display = 'block';
                document.getElementById('cameraPlaceholder').style.display = 'none';
                document.getElementById('startCameraBtn').style.display = 'none';
                document.getElementById('captureBtn').style.display = 'inline-block';
            }).catch(() => showNotification('Camera access denied. Use https or http://localhost.', 'error'));
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const capturedImg = document.getElementById('capturedPhoto');

            if (!video || !video.videoWidth) {
                showNotification('Camera not ready yet', 'warning');
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            capturedPhotoData = canvas.toDataURL('image/jpeg', 0.7);
            capturedImg.src = capturedPhotoData;
            capturedImg.style.display = 'block';
            video.style.display = 'none';

            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'inline-block';
            document.getElementById('markBtn').style.display = 'inline-block';

            if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
        }

        function retakePhoto() {
            capturedPhotoData = null;
            document.getElementById('capturedPhoto').style.display = 'none';
            document.getElementById('cameraPlaceholder').style.display = 'flex';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('markBtn').style.display = 'none';
            document.getElementById('startCameraBtn').style.display = 'inline-block';
        }

        /* Final submit */
        async function markAttendance() {
            if (!selectedType) return showNotification('Please select WFH / Office / Client', 'error');
            if (selectedType === 'office' && !selectedOffice) return showNotification('Please select an office', 'error');
            if (!capturedPhotoData) return showNotification('Please capture a photo', 'error');

            const markBtn = document.getElementById('markBtn');
            const markBtnText = document.getElementById('markBtnText');
            const markSpinner = document.getElementById('markSpinner');
            markBtn.disabled = true; markBtnText.classList.add('hidden'); markSpinner.classList.remove('hidden');

            try {
                const now = getCurrentDateTime();

                // Optional location for Office/Client
                let loc = null;
                if ((selectedType === 'office' || selectedType === 'client') && navigator.geolocation) {
                    try {
                        const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { timeout: 10000 }));
                        loc = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
                    } catch { }
                }

                const payload = {
                    employee_id: currentUser.id,
                    date: now.date,
                    check_in: now.time,
                    type: selectedType,
                    status: selectedType === 'office' ? 'present' : selectedType,
                    office_id: selectedType === 'office' ? selectedOffice : null,
                    location: loc,
                    photo: capturedPhotoData
                };

                const r = await apiCall('mark-attendance', 'POST', payload);
                if (r && r.success) {
                    showNotification('Attendance marked successfully');
                    if (typeof loadDashboardData === 'function') await loadDashboardData();
                    // refresh records if you‚Äôre on the Records screen
                    if (document.getElementById('recordsScreen').classList.contains('active')) {
                        await loadAttendanceRecords();
                    }
                    showScreen('dashboardScreen');
                }
                else {
                    showNotification((r && r.message) || 'Failed to mark attendance', 'error');
                }
            } finally {
                markBtn.disabled = false; markBtnText.classList.remove('hidden'); markSpinner.classList.add('hidden');
            }
        }

        // // (Optional) Keep this shim if something calls updateLocationStatus()
        // async function updateLocationStatus() {
        //     if (typeof checkAndUpdateLocationStatus === 'function') {
        //         return await checkAndUpdateLocationStatus();
        //     }
        //     return null;
        // }

        async function populateOfficeDropdowns() {
            try {
                const res = await apiCall('offices', 'GET', { active: 1 });
                const offices = (res && res.success) ? (res.offices || []) : [];

                // Signup page
                const signupOffice = document.getElementById('signupOffice');
                if (signupOffice) {
                    signupOffice.innerHTML = '<option value="">Select Office</option>' +
                        offices.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
                }

                // Admin ‚Üí Add New User
                const newUserPrimaryOffice = document.getElementById('newUserPrimaryOffice');
                if (newUserPrimaryOffice) {
                    newUserPrimaryOffice.innerHTML = '<option value="">Select Office</option>' +
                        offices.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
                }
            } catch (e) {
                console.error('Failed to load offices for dropdowns', e);
            }
        }

        //----------------------------------------------------------------------
        // Check-out Functions
        async function showCheckOut() {
            try {
                const result = await apiCall('today-attendance', 'GET', {
                    employee_id: currentUser.id
                });

                if (!result || !result.success || !result.record) {
                    showNotification('No check-in record found for today', 'error');
                    return;
                }

                const record = result.record;
                if (!record.check_in_time || !record.date) {
                    showNotification('No valid check-in time for today', 'error');
                    return;
                }

                const checkInTime = new Date(`${record.date}T${record.check_in_time}`);
                const now = new Date();
                const workHours = (now - checkInTime) / (1000 * 60 * 60);

                const totalMins = Math.max(0, Math.round(workHours * 60));
                const hh = Math.floor(totalMins / 60);
                const mm = totalMins % 60;

                // Populate modal
                const detailsDiv = document.getElementById('checkOutDetails');
                detailsDiv.innerHTML = `
      <div style="margin-bottom: 12px;"><strong>Office:</strong> ${record.office_name || 'N/A'}</div>
      <div style="margin-bottom: 12px;"><strong>Check In:</strong> ${record.check_in_time}</div>
      <div style="margin-bottom: 12px;"><strong>Current Time:</strong> ${getCurrentDateTime().time}</div>
      <div style="margin-bottom: 12px;"><strong>Work Hours:</strong> ${hh}h ${mm}m</div>
    `;

                const halfDayWarning = document.getElementById('halfDayWarning');
                if (workHours < 8) {
                    halfDayWarning.classList.remove('hidden');
                } else {
                    halfDayWarning.classList.add('hidden');
                }
                openModal('checkOutModal');
            } catch (error) {
                showNotification('Error loading check-in information', 'error');
                console.error('Error:', error);
            }
        }

        async function confirmCheckOut() {
            const confirmBtn = document.getElementById('confirmCheckOutBtn');
            const checkOutBtnText = document.getElementById('checkOutBtnText');
            const checkOutSpinner = document.getElementById('checkOutSpinner');

            confirmBtn.disabled = true;
            checkOutBtnText.classList.add('hidden');
            checkOutSpinner.classList.remove('hidden');

            try {
                const currentTime = getCurrentDateTime();

                // Try to get location, but don't block checkout if it fails
                let location = null;
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                        });
                        location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                    } catch (geoErr) {
                        console.warn('Checkout without location (non-blocking):', geoErr);
                    }
                }

                const result = await apiCall('check-out', 'POST', {
                    employee_id: currentUser.id,
                    date: currentTime.date,
                    check_out: currentTime.time,
                    location
                });

                // If server responded with non-JSON, apiCall gives { success:false, raw, status }
                if (!result || result.success !== true) {
                    console.error('Checkout API raw response:', result && result.raw);
                    showNotification((result && result.message) || 'Failed to record check-out', 'error');
                    return;
                }

                // Success path
                let message = 'Check-out recorded successfully!';
                if (result.is_half_day && typeof result.work_hours === 'number') {
                    message += ` (Marked as half day - ${result.work_hours.toFixed(1)} hours)`;
                }
                showNotification(message);

                // Close modal and refresh live cards (no full page reload)
                closeModal('checkOutModal');
                await loadDashboardData();              // updates Today card & stats
                // (Optional) If Records tab is visible, refresh it too:
                if (document.getElementById('recordsScreen')?.style.display === 'block') {
                    await loadAttendanceRecords();
                }
            } catch (err) {
                console.error('Error recording check-out:', err);
                showNotification('Error recording check-out', 'error');
            } finally {
                confirmBtn.disabled = false;
                checkOutBtnText.classList.remove('hidden');
                checkOutSpinner.classList.add('hidden');
            }
        }





        // Records Functions
        // 1) Load records (unchanged logic; just compact)
        async function loadAttendanceRecords() {
            try {
                const recordsContent = document.getElementById('recordsContent');

                recordsContent.innerHTML = `
      <div class="text-center" style="padding: 40px;">
        <div class="loading-spinner" style="margin: 0 auto 16px; width: 24px; height: 24px;"></div>
        <p>Loading attendance records...</p>
      </div>
    `;

                const params = {};
                if (currentUser.role !== 'admin') {
                    params.employee_id = currentUser.id;
                }

                const result = await apiCall('attendance-records', 'GET', params);

                const rows = (result && result.success && Array.isArray(result.records)) ? result.records : [];
                if (rows.length > 0) {
                    renderAttendanceTable(rows);
                } else {
                    recordsContent.innerHTML = `
        <div class="text-center" style="padding: 40px;">
          <p style="color: var(--gray-500);">No attendance records found.</p>
        </div>
      `;
                }
            } catch (error) {
                console.error('Error loading records:', error);
                document.getElementById('recordsContent').innerHTML = `
      <div class="text-center" style="padding: 40px;">
        <p style="color: var(--error-color);">Error loading records. Please try again.</p>
      </div>
    `;
            }
        }


        function renderAttendanceTable(records) {
            const recordsContent = document.getElementById('recordsContent');

            const tableHeaders = (currentUser.role === 'admin')
                ? ['Employee', 'Department', 'Date', 'Check In', 'Check Out', 'Hours', 'Type', 'Status', 'Office', 'Photo']
                : ['Date', 'Check In', 'Check Out', 'Hours', 'Type', 'Status', 'Office', 'Photo'];

            const rowsHtml = records.map(r => {
                const totalHours = (typeof r.total_hours === 'number')
                    ? `${Math.floor(r.total_hours)}h ${Math.round((r.total_hours % 1) * 60)}m`
                    : '-';

                const statusClass = `status-${String(r.status || '').replace('_', '')}`;
                const statusText = String(r.status || '').replace('_', ' ').toUpperCase();

                const photoCell = r.photo_url
                    ? `<img src="${r.photo_url}"
               alt="photo"
               style="width:64px;height:64px;border-radius:12px;object-fit:cover;aspect-ratio:1/1;">`
                    : '-';

                const common = `
      <td>${r.date || '-'}</td>
      <td>${r.check_in_time || '-'}</td>
      <td>${r.check_out_time || '-'}</td>
      <td>${totalHours}</td>
      <td>${(r.type || '').toUpperCase()}</td>
      <td><span class="status-badge ${statusClass}">${statusText}</span></td>
      <td>${r.office_name || '-'}</td>
      <td>${photoCell}</td>
    `;

                if (currentUser.role === 'admin') {
                    return `<tr>
        <td>${r.employee_name || ''}</td>
        <td>${r.department || ''}</td>
        ${common}
      </tr>`;
                } else {
                    return `<tr>${common}</tr>`;
                }
            }).join('');

            recordsContent.innerHTML = `
    <table class="records-table">
      <thead>
        <tr>${tableHeaders.map(h => `<th>${h}</th>`).join('')}</tr>
      </thead>
      <tbody>${rowsHtml}</tbody>
    </table>
  `;
        }



        /* 3) Helper: find a usable photo URL from various shapes your API might return.
              Priority:
              - record.photo_url (already provided by backend)
              - check_in_photo / check_out_photo (data URL, http/https, relative path, or raw base64)
        */
        function resolvePhotoUrl(r) {
            const candidate =
                r.photo_url ||
                r.check_in_photo ||
                r.check_out_photo ||
                null;

            if (!candidate) return null;

            // If it already looks like a URL or data URL, just use it
            if (/^(https?:|data:|blob:)/i.test(candidate)) return candidate;

            // Raw base64 (no data: prefix) ‚Üí wrap it
            const looksLikeBase64 = /^[A-Za-z0-9+/=\s]+$/.test(candidate) && candidate.length > 100;
            if (looksLikeBase64) return `data:image/jpeg;base64,${candidate}`;

            // Relative path on your server (e.g., "uploads/img123.jpg")
            // Adjust prefix if your images live elsewhere.
            if (!candidate.startsWith('/')) return `./${candidate}`;

            return candidate; // absolute path starting with /
        }



        /* Open Admin Panel and ALWAYS pull fresh data from DB */
        // === ADMIN: open panel and load everything ===
        async function openAdminPanel() {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Admins only.', 'warning');
                return;
            }
            showScreen('adminScreen');
            await Promise.all([refreshAdminOffices(), refreshAdminUsers(), refreshPrimaryOfficeSelects()]);
            accessibleOffices = [];
            adminOfficeEditId = null;
            document.getElementById('addOfficeMsg').textContent = '';
            document.getElementById('addUserMsg').textContent = '';
        }


        // Small helper to build query params
        function toQuery(obj) {
            return Object.keys(obj).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(obj[k])).join('&');
        }


        /* ----- Offices (list, add, delete) ----- */

        let adminOfficeEditId = null; // null = ADD, number = EDIT

        async function refreshAdminOffices() {
            const box = document.getElementById('adminOfficesList');
            box.innerHTML = '<div class="text-center" style="padding:12px;"><div class="loading-spinner" style="margin:0 auto;"></div> Loading offices‚Ä¶</div>';

            const res = await apiCall('offices-all', 'GET', { active: 1 });
            const offices = (res && res.success && Array.isArray(res.offices)) ? res.offices : [];

            document.getElementById('officeCount').textContent = `(${offices.length})`;
            box.innerHTML = renderOfficesTable(offices);
        }

        function renderOfficesTable(offices) {
            if (!offices.length) return '<p style="color:var(--gray-600)">No offices yet.</p>';

            const rows = offices.map(o => `
    <tr>
      <td>${o.id}</td>
      <td>${o.name || ''}</td>
      <td>${o.address || ''}</td>
      <td>${o.latitude ?? ''}</td>
      <td>${o.longitude ?? ''}</td>
      <td>${o.radius_meters ?? ''}</td>
      <td style="white-space:nowrap;">
        <button class="btn btn-secondary" onclick="startEditOffice(${o.id})">Edit</button>
        <button class="btn" style="background:#ef4444;color:#fff" onclick="deleteOffice(${o.id})">Delete</button>
      </td>
    </tr>
  `).join('');

            return `
    <div style="overflow:auto; max-height:420px;">
      <table class="records-table">
        <thead>
          <tr>
            <th style="width:60px">ID</th>
            <th>Name</th>
            <th>Address</th>
            <th>Lat</th>
            <th>Lng</th>
            <th>Radius(m)</th>
            <th style="width:160px">Actions</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
        }

        // Submit (add or update)
        function numOrNull(v) {
            const n = parseFloat(v);
            return Number.isFinite(n) ? n : null;
        }

        async function submitNewOffice() {
            const msg = document.getElementById('addOfficeMsg');
            msg.textContent = '';

            const name = document.getElementById('newOfficeName').value.trim();
            const address = document.getElementById('newOfficeAddress').value.trim();
            const lat = parseFloat(document.getElementById('newOfficeLat').value);
            const lng = parseFloat(document.getElementById('newOfficeLng').value);
            const radius = parseInt(document.getElementById('newOfficeRadius').value, 10);

            if (!name) return msg.textContent = 'Office name is required';
            if (Number.isNaN(lat) || Number.isNaN(lng) || Number.isNaN(radius)) {
                msg.textContent = 'Latitude, longitude and radius are required and must be numbers';
                return;
            }

            const payload = { name, address, latitude: lat, longitude: lng, radius_meters: radius };
            const endpoint = adminOfficeEditId ? `office/${adminOfficeEditId}` : 'office';
            const res = await apiCall(endpoint, 'POST', payload);

            if (res && res.success) {
                showNotification(adminOfficeEditId ? 'Office updated' : 'Office added');
                clearOfficeForm();
                await refreshAdminOffices();
                await refreshPrimaryOfficeSelects();
                await populateOfficeDropdowns();
                accessibleOffices = []; // drop cache so Attendance screen refreshes
            } else {
                msg.textContent = (res && res.message) ? res.message : 'Failed to save office';
            }
        }



        function clearOfficeForm() {
            adminOfficeEditId = null;
            document.getElementById('newOfficeName').value = '';
            document.getElementById('newOfficeAddress').value = '';
            document.getElementById('newOfficeLat').value = '';
            document.getElementById('newOfficeLng').value = '';
            document.getElementById('newOfficeRadius').value = '';
            document.getElementById('addOfficeMsg').textContent = '';
        }

        async function startEditOffice(id) {
            const res = await apiCall(`office/${id}`, 'GET');
            if (!res || !res.success || !res.office) {
                showNotification('Failed to load office', 'error');
                return;
            }
            const o = res.office;
            adminOfficeEditId = o.id;
            document.getElementById('newOfficeName').value = o.name || '';
            document.getElementById('newOfficeAddress').value = o.address || '';
            document.getElementById('newOfficeLat').value = o.latitude ?? '';
            document.getElementById('newOfficeLng').value = o.longitude ?? '';
            document.getElementById('newOfficeRadius').value = o.radius_meters ?? '';
            document.getElementById('addOfficeMsg').textContent = 'Editing office #' + o.id;
        }

        async function deleteOffice(id) {
            if (!confirm('Delete this office?')) return;
            let res = await fetch(`${apiBaseUrl}?endpoint=${encodeURIComponent('office/' + id)}`, { method: 'DELETE' })
                .then(r => r.json()).catch(() => null);
            if (res && res.success) {
                showNotification('Office deleted');
                await refreshAdminOffices();
                await refreshPrimaryOfficeSelects();
                accessibleOffices = [];
            } else {
                showNotification((res && res.message) || 'Failed to delete office', 'error');
            }
        }




        /* ----- Users (list, add, delete) ----- */

        async function refreshAdminUsers() {
            const tbody = document.getElementById('adminUsersList');
            tbody.innerHTML = `
    <tr><td colspan="7">
      <div class="text-center" style="padding:12px;"><div class="loading-spinner" style="margin:0 auto;"></div> Loading users‚Ä¶</div>
    </td></tr>`;

            const res = await apiCall('admin-users', 'GET');
            const users = (res && res.success && Array.isArray(res.users)) ? res.users : [];

            document.getElementById('userCount').textContent = `(${users.length})`;
            tbody.innerHTML = users.map(u => `
    <tr>
      <td>${u.id}</td>
      <td>${u.name || ''}</td>
      <td>${u.username || ''}</td>
      <td>${u.phone || ''}</td>
      <td>${u.department || ''}</td>
      <td>${u.role || ''}</td>
      <td style="white-space:nowrap;">
        <button class="btn btn-secondary" onclick="startEditUser(${u.id})">Edit</button>
        <button class="btn" style="background:#ef4444;color:#fff" onclick="deleteUser(${u.id})">Delete</button>
      </td>
    </tr>
  `).join('');
        }

        // Populate Primary Office dropdowns (signup + admin add user)
        // index.html
        async function refreshPrimaryOfficeSelects() {
            try {
                const res = await apiCall('offices', 'GET', { active: 1 });
                const offices = (res && res.success && Array.isArray(res.offices)) ? res.offices : [];

                const signupSel = document.getElementById('signupOffice');
                const adminSel = document.getElementById('newUserPrimaryOffice');

                const options = '<option value="">Select Office</option>' +
                    offices.map(o => `<option value="${o.id}">${o.name}</option>`).join('');

                if (signupSel) signupSel.innerHTML = options;
                if (adminSel) adminSel.innerHTML = options;
            } catch (e) {
                console.error('Failed to refresh primary office selects', e);
            }
        }

        async function submitNewUser() {
            const msg = document.getElementById('addUserMsg');
            msg.textContent = '';

            const payload = {
                name: document.getElementById('newUserName').value.trim(),
                username: document.getElementById('newUserUsername').value.trim(),
                phone: document.getElementById('newUserPhone').value.trim(),
                email: document.getElementById('newUserEmail').value.trim(),
                department: document.getElementById('newUserDepartment').value,
                primary_office: document.getElementById('newUserPrimaryOffice').value,
                role: document.getElementById('newUserRole').value,
            };

            const passwordVal = document.getElementById('newUserPassword').value.trim();

            if (!adminUserEditId) {
                // creating -> password required
                if (!passwordVal) {
                    msg.textContent = 'Password is required when creating a new user';
                    return;
                }
                payload.password = passwordVal;
            } else {
                // editing -> password optional
                if (passwordVal) payload.password = passwordVal;
            }

            // required fields
            if (!payload.name || !payload.username || !payload.email || !payload.phone ||
                !payload.department || !payload.primary_office) {
                msg.textContent = 'Please fill all required fields';
                return;
            }

            let endpoint = 'register';
            if (adminUserEditId) endpoint = `admin-user/${adminUserEditId}`;

            const res = await apiCall(endpoint, 'POST', payload);

            if (res && res.success) {
                showNotification(adminUserEditId ? 'User updated' : 'User added');
                adminUserEditId = null;
                clearUserForm();
                await refreshAdminUsers();
            } else {
                msg.textContent = (res && res.message) || 'Failed to save user';
            }
        }




        function clearUserForm() {
            adminUserEditId = null;
            ['newUserName', 'newUserUsername', 'newUserPhone', 'newUserEmail', 'newUserPassword'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('newUserDepartment').value = '';
            document.getElementById('newUserPrimaryOffice').value = '';
            document.getElementById('newUserRole').value = 'employee';
            document.getElementById('addUserMsg').textContent = '';
        }



        async function startEditUser(id) {
            try {
                const res = await apiCall(`admin-user/${id}`, 'GET');
                if (!res || !res.success || !res.user) {
                    showNotification('Failed to load user', 'error');
                    return;
                }
                const u = res.user;
                adminUserEditId = u.id;

                // Fill the Add New User form so admin can edit inline
                document.getElementById('newUserName').value = u.name || '';
                document.getElementById('newUserUsername').value = u.username || '';
                document.getElementById('newUserPhone').value = u.phone || '';
                document.getElementById('newUserEmail').value = u.email || '';
                document.getElementById('newUserDepartment').value = u.department || '';
                document.getElementById('newUserPrimaryOffice').value = u.primary_office || '';
                document.getElementById('newUserRole').value = u.role || 'employee';
                document.getElementById('newUserPassword').value = ''; // don't prefill password

                document.getElementById('addUserMsg').textContent = 'Editing user #' + u.id;
                // Scroll admin panel to the Add User card (optional nicety)
                document.getElementById('newUserName').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (e) {
                console.error('startEditUser error', e);
                showNotification('Error loading user', 'error');
            }
        }



        async function deleteUser(id) {
            if (!confirm('Delete this user?')) return;

            // Try real DELETE
            let res = await fetch(`${apiBaseUrl}?endpoint=${encodeURI('admin-user/' + id)}`, { method: 'DELETE' })
                .then(r => r.json()).catch(() => null);

            if (!res || res.success !== true) {
                // Fallback: POST with ?_method=DELETE
                res = await fetch(`${apiBaseUrl}?endpoint=${encodeURI('admin-user/' + id)}&_method=DELETE`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: '{}'
                }).then(r => r.json()).catch(() => null);
            }

            if (res && res.success) {
                showNotification('User deleted');
                await refreshAdminUsers();
            } else {
                showNotification((res && res.message) || 'Failed to delete user', 'error');
            }
        }

        function openProfile() {
            if (!currentUser) return;
            // populate fields
            document.getElementById('profileName').value = currentUser.name || '';
            document.getElementById('profileEmail').value = currentUser.email || '';
            document.getElementById('profilePhone').value = currentUser.phone || '';
            document.getElementById('profileDepartment').value = currentUser.department || '';
            document.getElementById('profilePassword').value = '';
            document.getElementById('profileMsg').textContent = '';
            showScreen('profileScreen');
        }

        async function saveProfile() {
            if (!currentUser) return;
            const btnText = document.getElementById('profileSaveText');
            const spin = document.getElementById('profileSaveSpinner');
            const msg = document.getElementById('profileMsg');

            const payload = {
                name: document.getElementById('profileName').value.trim(),
                email: document.getElementById('profileEmail').value.trim(),
                phone: document.getElementById('profilePhone').value.trim(),
                department: currentUser.department, // keep department same (locked in UI)
                role: currentUser.role,            // do not let user change role
                is_active: 1
            };

            // Optional: if user entered a new password, call a dedicated endpoint OR extend admin-user to accept it.
            const newPass = document.getElementById('profilePassword').value.trim();
            if (newPass.length > 0 && newPass.length < 6) {
                msg.textContent = 'Password must be at least 6 characters';
                return;
            }
            if (newPass) payload.password = newPass; // Only if your API supports it

            try {
                btnText.classList.add('hidden'); spin.classList.remove('hidden');

                // Reuse admin-user/{id} POST (your API updates name/email/phone/department/role/is_active)
                const res = await apiCall(`admin-user/${currentUser.id}`, 'POST', payload);

                if (res && res.success) {
                    // reflect changes locally
                    currentUser = { ...currentUser, ...payload };
                    localStorage.setItem('attendanceUser', JSON.stringify(currentUser));
                    showNotification('Profile updated');
                    msg.textContent = 'Saved.';
                } else {
                    showNotification((res && res.message) || 'Failed to update', 'error');
                    msg.textContent = (res && res.message) || 'Failed to update';
                }
            } catch (e) {
                showNotification('Error updating profile', 'error');
                msg.textContent = 'Error updating profile.';
            } finally {
                btnText.classList.remove('hidden'); spin.classList.add('hidden');
            }
        }


        async function exportToExcel() {
            // gate: admin only
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Export feature is available for admin users only', 'warning');
                return;
            }

            try {
                showNotification('Preparing export...');

                // Fetch all records (admin)
                const res = await apiCall('attendance-records', 'GET', {});
                if (!res || !res.success) {
                    showNotification('Export failed: API error', 'error');
                    console.error('Export API error:', res);
                    return;
                }

                const records = Array.isArray(res.records) ? res.records : [];
                if (records.length === 0) {
                    showNotification('No records to export', 'warning');
                    return;
                }

                // Create workbook & worksheet
                const wb = new ExcelJS.Workbook();
                const ws = wb.addWorksheet('Attendance');

                // Define headers
                const headers = [
                    { header: 'Employee', key: 'employee', width: 20 },
                    { header: 'Department', key: 'department', width: 14 },
                    { header: 'Date', key: 'date', width: 12 },
                    { header: 'Check In', key: 'check_in', width: 12 },
                    { header: 'Check Out', key: 'check_out', width: 12 },
                    { header: 'Total Hours', key: 'total_hours', width: 12 },
                    { header: 'Type', key: 'type', width: 10 },
                    { header: 'Status', key: 'status', width: 12 },
                    { header: 'Office', key: 'office', width: 18 },
                    { header: 'Photo', key: 'photo', width: 14 } // will hold image column
                ];

                ws.columns = headers;

                // Helper: convert dataURL -> base64 string (ExcelJS accepts base64)
                function extractBase64FromDataUrl(dataUrl) {
                    if (!dataUrl || typeof dataUrl !== 'string') return null;
                    const m = dataUrl.match(/^data:(image\/\w+);base64,(.*)$/);
                    if (!m) return null;
                    return { base64: m[2], ext: m[1].split('/')[1] }; // {base64, ext: 'jpeg'|'png' }
                }

                // Add rows first (text content). We'll add images after adding rows to compute row numbers.
                records.forEach(r => {
                    // Normalize employee name (admin export uses employee_name, else use currentUser)
                    let emp = r.employee_name || r.name || r.employee || (r.employee_id ? `#${r.employee_id}` : '');
                    ws.addRow({
                        employee: emp,
                        department: r.department || '',
                        date: r.date || '',
                        check_in: r.check_in_time || '',
                        check_out: r.check_out_time || '',
                        total_hours: typeof r.total_hours === 'number' ? r.total_hours : (r.total_hours || ''),
                        type: (r.type || '').toUpperCase(),
                        status: (r.status || '').toUpperCase(),
                        office: r.office_name || ''
                        // photo cell left blank; image will be placed over the cell
                    });
                });

                // Set uniform row height for image rows (e.g. 60 px). Header is row 1.
                const startRowIndex = 2; // rows start at 2 (1 is header)
                for (let i = startRowIndex; i < startRowIndex + records.length; i++) {
                    ws.getRow(i).height = 45; // adjust as needed to fit thumbnail
                }

                // Now add images
                for (let i = 0; i < records.length; i++) {
                    const rec = records[i];
                    // Your API sometimes returns photo_url or check_in_photo or photo field as data URL
                    const dataUrl = rec.photo_url || rec.check_in_photo || rec.photo || rec.photo_data || null;
                    if (!dataUrl) continue;
                    const info = extractBase64FromDataUrl(dataUrl);
                    if (!info) continue;

                    // Add image to workbook (ExcelJS supports base64 string)
                    let imageId;
                    try {
                        imageId = wb.addImage({
                            base64: info.base64,
                            extension: info.ext === 'jpeg' ? 'jpeg' : (info.ext || 'png')
                        });
                    } catch (e) {
                        console.warn('Failed to add image for row', i, e);
                        continue;
                    }

                    // Place image into the 'Photo' column. Find column index
                    const photoColIndex = ws.columns.findIndex(c => c.key === 'photo') + 1; // 1-based
                    const rowNumber = startRowIndex + i;

                    // Place image covering that cell with fixed size
                    ws.addImage(imageId, {
                        tl: { col: photoColIndex - 1 + 0.15, row: rowNumber - 1 + 0.12 }, // offset inside cell
                        ext: { width: 60, height: 40 } // thumbnail size (px)
                    });
                }

                // Optional: freeze header row
                ws.views = [{ state: 'frozen', ySplit: 1 }];

                // Generate and download
                const buf = await wb.xlsx.writeBuffer();
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                const filename = `attendance_report_${yyyy}-${mm}-${dd}.xlsx`;
                saveAs(new Blob([buf], { type: 'application/octet-stream' }), filename);
                showNotification('Report exported with photos!');
            } catch (err) {
                console.error('Export error (ExcelJS):', err);
                showNotification('Error exporting with images', 'error');
            }
        }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>


</body>

</html>