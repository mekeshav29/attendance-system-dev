<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance System - MySQL Powered</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-500: #64748b;
            --gray-700: #334155;
            --gray-900: #0f172a;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            min-height: 100vh;
            color: var(--gray-900);
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            border: 1px solid var(--gray-200);
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: var(--white);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
            text-align: center;
        }

        .login-subtitle {
            color: var(--gray-500);
            text-align: center;
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: var(--white);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            min-height: 48px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: var(--gray-500);
            color: var(--white);
        }

        .btn-success {
            background: var(--success-color);
            color: var(--white);
        }

        .btn-full-width {
            width: 100%;
        }

        .signup-link, .login-link {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--gray-200);
        }

        .signup-link a, .login-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .demo-credentials {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
            text-align: center;
            border: 1px solid var(--gray-200);
        }

        .demo-credentials h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .demo-credentials p {
            font-size: 14px;
            color: var(--gray-600);
            margin: 4px 0;
        }

        .header {
            background: var(--white);
            border-radius: 16px;
            padding: 20px 32px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-welcome {
            font-weight: 600;
            color: var(--gray-700);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .stat-card-value.success {
            color: var(--success-color);
        }

        .stat-card-value.warning {
            color: var(--warning-color);
        }

        .stat-card-value.error {
            color: var(--error-color);
        }

        .stat-card-timing {
            font-size: 14px;
            color: var(--gray-500);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .action-card {
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        .action-card-icon {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
        }

        .action-card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .action-card-description {
            color: var(--gray-500);
            font-size: 14px;
            line-height: 1.5;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .office-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }

        .office-card {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            position: relative;
        }

        .office-card:hover,
        .office-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
            transform: translateY(-2px);
        }

        .office-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .office-card h3 {
            color: var(--gray-900);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .office-card p {
            color: var(--gray-600);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .location-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .location-status.checking {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .location-status.in-range {
            background: #dcfce7;
            color: #166534;
        }

        .location-status.out-of-range {
            background: #fef3c7;
            color: #92400e;
        }

        .location-status.error {
            background: #fed7d7;
            color: #742a2a;
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 4/3;
        }

        .camera-container video,
        .camera-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .records-table th,
        .records-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .records-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 14px;
        }

        .records-table tr:hover {
            background: var(--gray-50);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-present {
            background: #dcfce7;
            color: #166534;
        }

        .status-wfh {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-half_day {
            background: #fef3c7;
            color: #92400e;
        }

        .status-client {
            background: #e0e7ff;
            color: #3730a3;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: var(--white);
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--error-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid,
            .actions-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
            
            .container {
                padding: 12px;
            }

            .office-selection {
                grid-template-columns: 1fr;
            }

            .camera-controls {
                flex-direction: column;
                align-items: center;
            }
        }
        /* Admin screens styling (small additions) */
#editOfficesCard, #editUsersCard {
    display: none;
    padding-top: 24px;
}
.screen.active#editOfficesCard, .screen.active#editUsersCard {
    display: block;
}
.admin-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.04);
    background: #fff;
}
.admin-table th, .admin-table td {
    padding: 12px 14px;
    border-bottom: 1px solid var(--gray-200);
    font-size: 14px;
    color: var(--gray-700);
}
.admin-table th {
    background: var(--gray-50);
    text-align: left;
    font-weight: 700;
}
.table-actions {
    display:flex;
    gap:8px;
}
.btn-icon {
    padding:6px 8px;
    min-height:36px;
    font-size:14px;
}
.modal-title { margin-bottom:12px; }
@media (max-width:768px) {
    .admin-table th, .admin-table td { padding:10px; font-size:13px; }
}
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-title">Employee Attendance System</div>
                <div class="login-subtitle">Sign in to mark your attendance</div>
                
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="loginUsername" class="form-control" placeholder="Enter your username" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-full-width" id="loginBtn">
                        <span id="loginBtnText">Sign In</span>
                        <span id="loginSpinner" class="loading-spinner hidden"></span>
                    </button>
                </form>
                
                <div class="signup-link">
                    <p>New employee? <a href="#" onclick="showScreen('signupScreen')">Sign up here</a></p>
                </div>
                
                <div class="demo-credentials">
                    <h4>Demo Credentials</h4>
                    <p><strong>Admin:</strong> admin / password</p>
                    <p><strong>Employee:</strong> john.doe / password</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Signup Screen -->
    <div id="signupScreen" class="screen">
        <div class="login-container">
            <div class="login-card" style="max-width: 600px;">
                <div class="login-title">Create Your Account</div>
                <div class="login-subtitle">Join our attendance system</div>
                
                <form onsubmit="handleSignup(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" id="signupName" class="form-control" placeholder="Enter full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" id="signupPhone" class="form-control" placeholder="10-digit number" required pattern="[0-9]{10}">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="signupEmail" class="form-control" placeholder="Enter email" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Department</label>
                            <select id="signupDepartment" class="form-control" required>
                                <option value="">Select Department</option>
                                <option value="IT">IT</option>
                                <option value="HR">HR</option>
                                <option value="Surveyors">Surveyors</option>
                                <option value="Accounts">Accounts</option>
                                <option value="Growth">Growth</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Primary Office</label>
                            <select id="signupOffice" class="form-control" required>
                                <option value="">Select Office</option>
                                <option value="79">79 Office</option>
                                <option value="105">105 Office</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" id="signupUsername" class="form-control" placeholder="Choose username" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" id="signupPassword" class="form-control" placeholder="Create password" required minlength="6">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-full-width" id="signupBtn">
                        <span id="signupBtnText">Create Account</span>
                        <span id="signupSpinner" class="loading-spinner hidden"></span>
                    </button>
                </form>
                
                <div class="login-link">
                    <p>Already have an account? <a href="#" onclick="showScreen('loginScreen')">Sign in here</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="screen">
        <div class="container">
            <div class="header">
                <div class="header-title">Attendance Dashboard</div>
                <div class="header-user">
                    <span class="user-welcome">Welcome, <span id="userName">User</span></span>
                    <button onclick="logout()" class="btn btn-secondary">Logout</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-title">Today's Status</div>
                    <div class="stat-card-value" id="todayStatus">Not Marked</div>
                    <div class="stat-card-timing" id="todayTiming"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">This Month</div>
                    <div class="stat-card-value" id="monthlyDays">0</div>
                    <div class="stat-card-timing">Working Days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">WFH Used</div>
                    <div class="stat-card-value" id="wfhCount">0/1</div>
                    <div class="stat-card-timing">This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">Location Status</div>
                    <div class="stat-card-value" id="locationStatus">Checking...</div>
                    <div class="stat-card-timing" id="locationDistance"></div>
                </div>
            </div>

            <div class="actions-grid">
                <div class="action-card" onclick="startAttendanceFlow()" id="checkInCard">
                    <span class="action-card-icon">üìç</span>
                    <div class="action-card-title">Check In</div>
                    <div class="action-card-description">Mark your attendance with location and photo</div>
                </div>
                <div class="action-card hidden" onclick="showCheckOut()" id="checkOutCard">
                    <span class="action-card-icon">üèÉ</span>
                    <div class="action-card-title">Check Out</div>
                    <div class="action-card-description">Complete your work day</div>
                </div>
                <div class="action-card" onclick="showScreen('recordsScreen')">
                    <span class="action-card-icon">üìã</span>
                    <div class="action-card-title">My Records</div>
                    <div class="action-card-description">View your attendance history</div>
                </div>
                <div class="action-card hidden" onclick="exportToExcel()" id="adminCard">
                    <span class="action-card-icon">üìä</span>
                    <div class="action-card-title">Export Data</div>
                    <div class="action-card-description">Download attendance report (Admin only)</div>
                </div>
                 <div class="action-card" onclick="showScreen('editOfficesCard')" id="editOfficesCard">
                    <span class="action-card-icon">üè¢</span>
                    <div class="action-card-title">Edit Offices</div>
                    <div class="action-card-description">Add/Edit Offices</div>
                </div>
                <div class="action-card" onclick="showScreen('editUsersCard')">
                    <span class="action-card-icon">üë•</span>
                    <div class="action-card-title">Users</div>
                    <div class="action-card-description">Add/Edit Users</div>
                </div>
            </div>
        </div>
    </div>
    <div id="editOfficesCard" class="screen" style="display:none;">
    <div class="container">
        <div class="header">
            <div class="header-title">Manage Offices</div>
            <div style="display:flex; gap:12px; align-items:center;">
                <button onclick="showScreen('dashboardScreen')" class="btn btn-secondary">‚Üê Back</button>
                <button onclick="openOfficeModal()" class="btn btn-primary">+ New Office</button>
            </div>
        </div>

        <div class="card">
            <div id="officesAdminContent">
                <div class="text-center" style="padding:20px;">
                    <div class="loading-spinner" style="margin:0 auto 12px; width:24px; height:24px;"></div>
                    <p>Loading offices...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="editUsersCard" class="screen" style="display:none;">
    <div class="container">
        <div class="header">
            <div class="header-title">Manage Users</div>
            <div style="display:flex; gap:12px; align-items:center;">
                <button onclick="showScreen('dashboardScreen')" class="btn btn-secondary">‚Üê Back</button>
                <button onclick="openUserModal()" class="btn btn-primary">+ New User</button>
            </div>
        </div>

        <div class="card">
            <div id="usersAdminContent">
                <div class="text-center" style="padding:20px;">
                    <div class="loading-spinner" style="margin:0 auto 12px; width:24px; height:24px;"></div>
                    <p>Loading users...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Office Modal -->
<div id="officeModal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title">Add / Edit Office</h3>
        <form id="officeForm" onsubmit="saveOffice(event)">
            <input type="hidden" id="office_id">
            <div class="form-group">
                <label class="form-label">Name</label>
                <input id="office_name" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Address</label>
                <input id="office_address" class="form-control" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Latitude</label>
                    <input id="office_lat" type="number" step="any" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Longitude</label>
                    <input id="office_lng" type="number" step="any" class="form-control" required>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Radius (meters)</label>
                <input id="office_radius" type="number" class="form-control" required>
            </div>
            <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:16px;">
                <button type="button" onclick="closeModal('officeModal')" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- User Modal -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title">Add / Edit User</h3>
        <form id="userForm" onsubmit="saveUser(event)">
            <input type="hidden" id="user_id">
            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input id="user_name" class="form-control" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input id="user_username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input id="user_password" type="password" class="form-control" placeholder="Leave blank to keep">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input id="user_email" type="email" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input id="user_phone" class="form-control">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Department</label>
                    <select id="user_department" class="form-control">
                        <option value="">--</option>
                        <option>IT</option><option>HR</option><option>Surveyors</option><option>Accounts</option><option>Growth</option><option>Others</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select id="user_role" class="form-control" required>
                        <option value="employee">Employee</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>
            <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:16px;">
                <button type="button" onclick="closeModal('userModal')" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>
    <!-- Attendance Screen -->
    <div id="attendanceScreen" class="screen">
        <div class="container">
            <div class="header">
                <div class="header-title">Mark Attendance</div>
                <button onclick="showScreen('dashboardScreen')" class="btn btn-secondary">‚Üê Back</button>
            </div>

            <div class="card">
                <h3>Select Office Location:</h3>
                <p style="color: var(--gray-500); margin-bottom: 20px;">Only offices within range will be enabled for selection</p>
                <div class="office-selection" id="officeSelection">
                    <!-- Office cards populated by JavaScript -->
                </div>

                <div id="typeSelectionSection" class="hidden" style="margin-top: 32px;">
                    <h3>Select Attendance Type:</h3>
                    <div class="office-selection" id="typeSelection">
                        <div class="office-card" onclick="selectType('office', this)">
                            <span class="action-card-icon">üè¢</span>
                            <h3>Office Work</h3>
                            <p>Regular office attendance</p>
                        </div>
                        <div class="office-card" onclick="selectType('wfh', this)" id="wfhOption">
                            <span class="action-card-icon">üè†</span>
                            <h3>Work From Home</h3>
                            <p id="wfhStatus">Checking eligibility...</p>
                        </div>
                        <div class="office-card" onclick="selectType('client', this)">
                            <span class="action-card-icon">üè¢</span>
                            <h3>Client Office</h3>
                            <p>Working at client location</p>
                        </div>
                    </div>
                </div>
                <div id="cameraSection" class="hidden" style="margin-top: 32px;">
                    <h3>Take Your Photo:</h3>
                    <p style="color: var(--gray-500); margin-bottom: 20px;">Photo is required for attendance verification</p>
                    <div class="camera-container">
                        <video id="video" autoplay muted playsinline style="display:none;"></video>
                        <img id="capturedPhoto" style="display:none;">
                        <div id="cameraPlaceholder" style="display:flex; align-items:center; justify-content:center; height:100%; background:#f3f4f6; color:#6b7280;">
                            Click "Start Camera" to begin
                        </div>
                    </div>
                    <div class="camera-controls">
                        <button onclick="startCamera()" class="btn btn-primary" id="startCameraBtn">üì∑ Start Camera</button>
                        <button onclick="capturePhoto()" class="btn btn-success" id="captureBtn" style="display:none;">üì∏ Capture</button>
                        <button onclick="retakePhoto()" class="btn btn-secondary" id="retakeBtn" style="display:none;">üîÑ Retake</button>
                    </div>
                    <div class="text-center" style="margin-top: 20px;">
                        <button onclick="markAttendance()" class="btn btn-success" id="markBtn" style="display:none;">
                            <span id="markBtnText">‚úÖ Mark Attendance</span>
                            <span id="markSpinner" class="loading-spinner hidden"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Records Screen -->
    <div id="recordsScreen" class="screen">
        <div class="container">
            <div class="header">
                <div class="header-title">Attendance Records</div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <span id="adminExportNote" class="hidden" style="color: var(--gray-500); font-size: 14px;">(Admin: Export available)</span>
                    <button onclick="showScreen('dashboardScreen')" class="btn btn-secondary">‚Üê Back</button>
                </div>
            </div>

            <div class="card">
                <div id="recordsContent">
                    <div class="text-center" style="padding: 40px;">
                        <div class="loading-spinner" style="margin: 0 auto 16px; width: 24px; height: 24px;"></div>
                        <p>Loading attendance records...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="text-center">
                <div style="font-size: 64px; margin-bottom: 16px;">‚úÖ</div>
                <h3 style="margin-bottom: 16px;">Success!</h3>
                <p id="successMessage" style="margin-bottom: 24px;">Operation completed successfully.</p>
                <button onclick="closeModal('successModal')" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Check Out Confirmation Modal -->
    <div id="checkOutModal" class="modal">
        <div class="modal-content">
            <div class="text-center">
                <div style="font-size: 48px; margin-bottom: 16px;">üèÉ</div>
                <h3 style="margin-bottom: 16px;">Check Out Confirmation</h3>
                <div id="checkOutDetails" style="margin-bottom: 24px; text-align: left;"></div>
                <div id="halfDayWarning" class="hidden" style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 20px; color: #92400e;">
                    <h4>‚ö†Ô∏è Half Day Warning</h4>
                    <p>You have worked less than 8 hours. This will be marked as a half day.</p>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button onclick="closeModal('checkOutModal')" class="btn btn-secondary">Cancel</button>
                    <button onclick="confirmCheckOut()" class="btn btn-primary" id="confirmCheckOutBtn">
                        <span id="checkOutBtnText">Confirm Check Out</span>
                        <span id="checkOutSpinner" class="loading-spinner hidden"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Global Variables
        let currentUser = null;
        let selectedOffice = null;
        let selectedType = null;
        let capturedPhotoData = null;
        let stream = null;
        let accessibleOffices = [];

        // API Configuration
        const API_BASE_URL = `${window.location.origin}/attendance-system-dev/api.php`;

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('MySQL Attendance System Initializing...');
            
            // Check for stored user session
            const storedUser = localStorage.getItem('attendanceUser');
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    showScreen('dashboardScreen');
                    loadDashboardData();
                } catch (e) {
                    localStorage.removeItem('attendanceUser');
                }
            }
        });

        // Utility Functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            // Screen-specific initialization
            if (screenId === 'recordsScreen') {
                loadAttendanceRecords();
            } else if (screenId === 'attendanceScreen') {
                resetAttendanceFlow();
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => notification.classList.remove('show'), 4000);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatTime(date) {
            return date.toTimeString().split(' ')[0].substring(0, 5);
        }

        function getCurrentDateTime() {
            const now = new Date();
            return {
                date: formatDate(now),
                time: formatTime(now)
            };
            const API_BASE_URL = '${window.location.origin}/attendance-system-dev/api.php'; // Remove window.location.origin            // Update the apiCall function in index.html
            async function apiCall(endpoint, method = 'GET', data = null) {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }
                
                let url = `${API_BASE_URL}/${endpoint}`;
                
                if (method === 'GET' && data) {
                    const params = new URLSearchParams(data);
                    url += `?${params}`;
                }
                
                try {
                    console.log(`API Call: ${method} ${url}`);
                    const response = await fetch(url, options);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log(`API Response:`, result);
                    return result;
                } catch (error) {
                    console.error('API Error:', error);
                    showNotification('Connection error. Please check if the server is running.', 'error');
                    return { success: false, message: 'Connection error' };
                }
            }
        }

        // API Functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };
            
            if (data && method !== 'GET') {
                options.body = JSON.stringify(data);
            }

            let url = `${API_BASE_URL}/${endpoint}`;

            if (method === 'GET' && data) {
                const params = new URLSearchParams(data);
                url += `?${params}`;
            }
            
            try {
                console.log(`API Call: ${method} ${url}`);
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log(`API Response:`, result);
                return result;
            } catch (error) {
                console.error('API Error:', error);
                showNotification('Connection error. Please check if the server is running.', 'error');
                return { success: false, message: 'Connection error' };
            }
        }

        // Authentication Functions
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginSpinner = document.getElementById('loginSpinner');

            if (!username || !password) {
                showNotification('Please enter username and password', 'error');
                return;
            }

            // Show loading state
            loginBtn.disabled = true;
            loginBtnText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');
            
            try {
                const result = await apiCall('login', 'POST', {
                    username: username,
                    password: password
                });
                
                if (result.success) {
                    currentUser = result.user;
                    localStorage.setItem('attendanceUser', JSON.stringify(currentUser));
                    
                    showNotification('Login successful!');
                    showScreen('dashboardScreen');
                    await loadDashboardData();
                } else {
                    showNotification(result.message || 'Login failed', 'error');
                }
            } finally {
                // Reset button state
                loginBtn.disabled = false;
                loginBtnText.classList.remove('hidden');
                loginSpinner.classList.add('hidden');
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('signupName').value,
                phone: document.getElementById('signupPhone').value,
                email: document.getElementById('signupEmail').value,
                department: document.getElementById('signupDepartment').value,
                primary_office: document.getElementById('signupOffice').value,
                username: document.getElementById('signupUsername').value,
                password: document.getElementById('signupPassword').value
            };

            const signupBtn = document.getElementById('signupBtn');
            const signupBtnText = document.getElementById('signupBtnText');
            const signupSpinner = document.getElementById('signupSpinner');

            // Show loading state
            signupBtn.disabled = true;
            signupBtnText.classList.add('hidden');
            signupSpinner.classList.remove('hidden');

            try {
                const result = await apiCall('register', 'POST', formData);
                
                if (result.success) {
                    showNotification('Account created successfully! Please login.');
                    showScreen('loginScreen');
                    
                    // Clear form
                    Object.keys(formData).forEach(key => {
                        const element = document.getElementById(`signup${key.charAt(0).toUpperCase()}${key.slice(1).replace('_', '')}`);
                        if (element) element.value = '';
                    });
                } else {
                    showNotification(result.message || 'Registration failed', 'error');
                }
            } finally {
                // Reset button state
                signupBtn.disabled = false;
                signupBtnText.classList.remove('hidden');
                signupSpinner.classList.add('hidden');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('attendanceUser');
            showNotification('Logged out successfully');
            showScreen('loginScreen');
        }

        // Dashboard Functions
        async function loadDashboardData() {
            if (!currentUser) return;

            document.getElementById('userName').textContent = currentUser.name;

            // Show admin features for admin users
            if (currentUser.role === 'admin') {
                document.getElementById('adminCard').classList.remove('hidden');
                document.getElementById('adminExportNote').classList.remove('hidden');
            }

            // Load data in parallel
            await Promise.all([
                loadTodayAttendance(),
                loadMonthlyStats(),
                loadWFHEligibility(),
                updateLocationStatus()
            ]);
        }

        async function loadTodayAttendance() {
            try {
                const result = await apiCall('today-attendance', 'GET', {
                    employee_id: currentUser.id
                });

                const statusElement = document.getElementById('todayStatus');
                const timingElement = document.getElementById('todayTiming');
                const checkInCard = document.getElementById('checkInCard');
                const checkOutCard = document.getElementById('checkOutCard');

                if (result.success && result.record) {
                    const record = result.record;
                    
                    if (record.check_out_time) {
                        statusElement.textContent = 'Completed';
                        statusElement.className = 'stat-card-value success';
                        timingElement.textContent = `${record.check_in_time} - ${record.check_out_time}`;
                        checkInCard.classList.add('hidden');
                        checkOutCard.classList.add('hidden');
                    } else {
                        statusElement.textContent = 'Checked In';
                        statusElement.className = 'stat-card-value success';
                        timingElement.textContent = `Since ${record.check_in_time}`;
                        checkInCard.classList.add('hidden');
                        checkOutCard.classList.remove('hidden');
                    }
                } else {
                    statusElement.textContent = 'Not Marked';
                    statusElement.className = 'stat-card-value error';
                    timingElement.textContent = '';
                    checkInCard.classList.remove('hidden');
                    checkOutCard.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading today attendance:', error);
            }
        }

        async function loadMonthlyStats() {
            try {
                const result = await apiCall('monthly-stats', 'GET', {
                    employee_id: currentUser.id
                });

                const monthlyDaysElement = document.getElementById('monthlyDays');
                if (result.success && result.stats) {
                    monthlyDaysElement.textContent = result.stats.total_days || 0;
                }
            } catch (error) {
                console.error('Error loading monthly stats:', error);
            }
        }

        async function loadWFHEligibility() {
            try {
                const result = await apiCall('wfh-eligibility', 'GET', {
                    employee_id: currentUser.id,
                    date: getCurrentDateTime().date
                });

                const wfhCountElement = document.getElementById('wfhCount');
                if (result) {
                    const currentCount = result.current_count || 0;
                    const maxLimit = result.max_limit || 1;
                    
                    wfhCountElement.textContent = `${currentCount}/${maxLimit}`;
                    
                    if (currentCount >= maxLimit) {
                        wfhCountElement.className = 'stat-card-value warning';
                    } else {
                        wfhCountElement.className = 'stat-card-value success';
                    }
                }
            } catch (error) {
                console.error('Error loading WFH eligibility:', error);
            }
        }

        function updateLocationStatus() {
            const statusElement = document.getElementById('locationStatus');
            const distanceElement = document.getElementById('locationDistance');

            if (!navigator.geolocation) {
                statusElement.textContent = 'Not Supported';
                statusElement.className = 'stat-card-value error';
                return;
            }

            statusElement.textContent = 'Checking...';
            statusElement.className = 'stat-card-value';

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    try {
                        const result = await apiCall('offices', 'GET', {
                            department: currentUser.department
                        });

                        if (result.success && result.offices.length > 0) {
                            let nearestOffice = null;
                            let minDistance = Infinity;

                            result.offices.forEach(office => {
                                const distance = calculateDistance(
                                    position.coords.latitude,
                                    position.coords.longitude,
                                    parseFloat(office.latitude),
                                    parseFloat(office.longitude)
                                );

                                if (distance < minDistance) {
                                    minDistance = distance;
                                    nearestOffice = office;
                                }
                            });

                            if (nearestOffice) {
                                if (minDistance <= nearestOffice.radius_meters) {
                                    statusElement.textContent = 'In Range';
                                    statusElement.className = 'stat-card-value success';
                                    distanceElement.textContent = `${nearestOffice.name} (${Math.round(minDistance)}m)`;
                                } else {
                                    statusElement.textContent = 'Out of Range';
                                    statusElement.className = 'stat-card-value warning';
                                    distanceElement.textContent = `${Math.round(minDistance)}m from ${nearestOffice.name}`;
                                }
                            }
                        }
                    } catch (error) {
                        statusElement.textContent = 'Error';
                        statusElement.className = 'stat-card-value error';
                    }
                },
                () => {
                    statusElement.textContent = 'Location Error';
                    statusElement.className = 'stat-card-value error';
                    distanceElement.textContent = 'Cannot access GPS';
                }
            );
        }

        // Attendance Flow Functions
        async function startAttendanceFlow() {
            showScreen('attendanceScreen');
            await loadOfficeSelection();
        }

        function resetAttendanceFlow() {
            selectedOffice = null;
            selectedType = null;
            capturedPhotoData = null;
            
            document.getElementById('typeSelectionSection').classList.add('hidden');
            document.getElementById('cameraSection').classList.add('hidden');
            
            // Reset camera
            const video = document.getElementById('video');
            const photo = document.getElementById('capturedPhoto');
            const placeholder = document.getElementById('cameraPlaceholder');
            
            video.style.display = 'none';
            photo.style.display = 'none';
            placeholder.style.display = 'flex';
            
            document.getElementById('startCameraBtn').style.display = 'inline-block';
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('markBtn').style.display = 'none';

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        async function loadOfficeSelection() {
            try {
                const result = await apiCall('offices', 'GET', {
                    department: currentUser.department
                });

                if (!result.success) {
                    showNotification('Failed to load office information', 'error');
                    return;
                }

                accessibleOffices = result.offices;
                const container = document.getElementById('officeSelection');

                if (accessibleOffices.length === 0) {
                    container.innerHTML = '<p>No offices accessible for your department.</p>';
                    return;
                }

                container.innerHTML = '';
                
                // Get user location first
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            await renderOfficeCards(position.coords.latitude, position.coords.longitude);
                        },
                        () => {
                            // Render without location check
                            renderOfficeCardsWithoutLocation();
                        }
                    );
                } else {
                    renderOfficeCardsWithoutLocation();
                }
            } catch (error) {
                showNotification('Error loading offices', 'error');
                console.error('Error:', error);
            }
        }

        async function renderOfficeCards(userLat, userLng) {
            const container = document.getElementById('officeSelection');
            
            container.innerHTML = '';
            
            for (const office of accessibleOffices) {
                const distance = calculateDistance(
                    userLat, userLng,
                    parseFloat(office.latitude),
                    parseFloat(office.longitude)
                );
                
                const inRange = distance <= office.radius_meters;
                const cardClass = inRange ? 'office-card' : 'office-card disabled';
                
                const officeCard = document.createElement('div');
                officeCard.className = cardClass;
                officeCard.innerHTML = `
                                        <span class="action-card-icon">üè¢</span>
                    <h3>${office.name}</h3>
                    <p>${office.address}</p>
                    <div class="location-status ${inRange ? 'in-range' : 'out-of-range'}">
                        ${inRange ? 'In Range' : 'Out of Range'} (${Math.round(distance)}m)
                    </div>
                `;
                
                if (inRange) {
                    officeCard.onclick = () => selectOffice(office.id);
                }
                
                container.appendChild(officeCard);
            }
        }

        function renderOfficeCardsWithoutLocation() {
            const container = document.getElementById('officeSelection');
            
            container.innerHTML = '';
            
            accessibleOffices.forEach(office => {
                const officeCard = document.createElement('div');
                officeCard.className = 'office-card';
                officeCard.innerHTML = `
                  <span class="action-card-icon">üè¢</span>
                    <h3>${office.name}</h3>
                    <p>${office.address}</p>
                    <div class="location-status checking">Location check unavailable</div>
                `;
                
                officeCard.onclick = () => selectOffice(office.id);
                container.appendChild(officeCard);
            });
        }

        async function selectOffice(officeId) {
            selectedOffice = officeId;
            
            // Update UI
            document.querySelectorAll('#officeSelection .office-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.office-card').classList.add('selected');

            // Show type selection
            document.getElementById('typeSelectionSection').classList.remove('hidden');
            
            // Load WFH eligibility
            await updateWFHOption();
        }

        async function updateWFHOption() {
            try {
                const result = await apiCall('wfh-eligibility', 'GET', {
                    employee_id: currentUser.id,
                    date: getCurrentDateTime().date
                });

                const wfhOption = document.getElementById('wfhOption');
                const wfhStatus = document.getElementById('wfhStatus');

                if (result && result.can_request) {
                    wfhStatus.textContent = `Available (${result.current_count || 0}/${result.max_limit || 1})`;
                    wfhStatus.style.color = 'var(--success-color)';
                    wfhOption.classList.remove('disabled');
                } else {
                    wfhStatus.textContent = 'Limit Reached';
                    wfhStatus.style.color = 'var(--error-color)';
                    wfhOption.classList.add('disabled');
                    wfhOption.onclick = () => {
                        showNotification('WFH limit exceeded for this month', 'error');
                    };
                }
            } catch (error) {
                console.error('Error checking WFH eligibility:', error);
            }
        }

        function selectType(type) {
            if (type === 'wfh') {
                const wfhOption = document.getElementById('wfhOption');
                if (wfhOption.classList.contains('disabled')) {
                    return;
                }
            }

            selectedType = type;
            
            // Update UI
            document.querySelectorAll('#typeSelection .office-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.office-card').classList.add('selected');

            // Show camera section
            document.getElementById('cameraSection').classList.remove('hidden');
        }

        // Camera Functions
        function startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification('Camera not supported on this device', 'error');
                return;
            }

            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'user',
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                } 
            })
            .then(mediaStream => {
                stream = mediaStream;
                const video = document.getElementById('video');
                video.srcObject = mediaStream;
                video.style.display = 'block';
                
                document.getElementById('cameraPlaceholder').style.display = 'none';
                document.getElementById('startCameraBtn').style.display = 'none';
                document.getElementById('captureBtn').style.display = 'inline-block';
            })
            .catch(error => {
                console.error('Camera error:', error);
                showNotification('Camera access denied', 'error');
            });
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const capturedImg = document.getElementById('capturedPhoto');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0);
            
            // Convert to JPEG with compression
            capturedPhotoData = canvas.toDataURL('image/jpeg', 0.7);
            
            // Show captured photo
            capturedImg.src = capturedPhotoData;
            capturedImg.style.display = 'block';
            video.style.display = 'none';
            
            // Update buttons
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'inline-block';
            document.getElementById('markBtn').style.display = 'inline-block';
            
            // Stop camera
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function retakePhoto() {
            capturedPhotoData = null;
            
            document.getElementById('capturedPhoto').style.display = 'none';
            document.getElementById('cameraPlaceholder').style.display = 'flex';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('markBtn').style.display = 'none';
            document.getElementById('startCameraBtn').style.display = 'inline-block';
        }

        async function markAttendance() {
            if (!selectedOffice || !selectedType || !capturedPhotoData) {
                showNotification('Please complete all steps', 'error');
                return;
            }

            const markBtn = document.getElementById('markBtn');
            const markBtnText = document.getElementById('markBtnText');
            const markSpinner = document.getElementById('markSpinner');

            // Show loading state
            markBtn.disabled = true;
            markBtnText.classList.add('hidden');
            markSpinner.classList.remove('hidden');

            try {
                const currentTime = getCurrentDateTime();
                
                // Get current location
                let location = null;
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                        });
                        location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                    } catch (error) {
                        console.warn('Could not get location:', error);
                    }
                }

                const attendanceData = {
                    employee_id: currentUser.id,
                    date: currentTime.date,
                    check_in: currentTime.time,
                    type: selectedType,
                    status: selectedType === 'office' ? 'present' : selectedType,
                    office_id: selectedType === 'wfh' ? null : selectedOffice,
                    location: location,
                    photo: capturedPhotoData
                };

                const result = await apiCall('mark-attendance', 'POST', attendanceData);
                
                if (result.success) {
                    showModal('successModal', 'Attendance marked successfully!');
                } else {
                    showNotification(result.message || 'Failed to mark attendance', 'error');
                }
            } catch (error) {
                showNotification('Error marking attendance', 'error');
                console.error('Error:', error);
            } finally {
                // Reset button state
                markBtn.disabled = false;
                markBtnText.classList.remove('hidden');
                markSpinner.classList.add('hidden');
            }
        }

        // Check-out Functions
        async function showCheckOut() {
            try {
                const result = await apiCall('today-attendance', 'GET', {
                    employee_id: currentUser.id
                });

                if (!result.success || !result.record) {
                    showNotification('No check-in record found for today', 'error');
                    return;
                }

                const record = result.record;
                const checkInTime = new Date(`${record.date}T${record.check_in_time}`);
                const now = new Date();
                const workHours = (now - checkInTime) / (1000 * 60 * 60);

                // Populate modal
                const detailsDiv = document.getElementById('checkOutDetails');
                detailsDiv.innerHTML = `
                    <div style="margin-bottom: 12px;"><strong>Office:</strong> ${record.office_name || 'N/A'}</div>
                    <div style="margin-bottom: 12px;"><strong>Check In:</strong> ${record.check_in_time}</div>
                    <div style="margin-bottom: 12px;"><strong>Current Time:</strong> ${getCurrentDateTime().time}</div>
                    <div style="margin-bottom: 12px;"><strong>Work Hours:</strong> ${Math.floor(workHours)}h ${Math.round((workHours % 1) * 60)}m</div>
                `;

                const halfDayWarning = document.getElementById('halfDayWarning');
                if (workHours < 8) {
                    halfDayWarning.classList.remove('hidden');
                } else {
                    halfDayWarning.classList.add('hidden');
                }

                document.getElementById('checkOutModal').classList.add('active');
            } catch (error) {
                showNotification('Error loading check-in information', 'error');
                console.error('Error:', error);
            }
        }

        async function confirmCheckOut() {
            const confirmBtn = document.getElementById('confirmCheckOutBtn');
            const checkOutBtnText = document.getElementById('checkOutBtnText');
            const checkOutSpinner = document.getElementById('checkOutSpinner');

            // Show loading state
            confirmBtn.disabled = true;
            checkOutBtnText.classList.add('hidden');
            checkOutSpinner.classList.remove('hidden');

            try {
                const currentTime = getCurrentDateTime();
                
                // Get current location
                let location = null;
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                        });
                        location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                    } catch (error) {
                        console.warn('Could not get location for check-out:', error);
                    }
                }

                const result = await apiCall('check-out', 'POST', {
                    employee_id: currentUser.id,
                    date: currentTime.date,
                    check_out: currentTime.time,
                    location: location
                });

                if (result.success) {
                    let message = 'Check-out recorded successfully!';
                    if (result.is_half_day) {
                        message += ` (Marked as half day - ${result.work_hours.toFixed(1)} hours)`;
                    }
                    
                    showNotification(message);
                    closeModal('checkOutModal');
                    loadDashboardData();
                } else {
                    showNotification(result.message || 'Failed to record check-out', 'error');
                }
            } catch (error) {
                showNotification('Error recording check-out', 'error');
                console.error('Error:', error);
            } finally {
                // Reset button state
                confirmBtn.disabled = false;
                checkOutBtnText.classList.remove('hidden');
                checkOutSpinner.classList.add('hidden');
            }
        }

        // Records Functions
        async function loadAttendanceRecords() {
            try {
                const recordsContent = document.getElementById('recordsContent');
                
                // Show loading
                recordsContent.innerHTML = `
                    <div class="text-center" style="padding: 40px;">
                        <div class="loading-spinner" style="margin: 0 auto 16px; width: 24px; height: 24px;"></div>
                        <p>Loading attendance records...</p>
                    </div>
                `;

                // Determine which records to load
                const params = {};
                if (currentUser.role !== 'admin') {
                    params.employee_id = currentUser.id;
                }

                const result = await apiCall('attendance-records', 'GET', params);

                if (result.success && result.records && result.records.length > 0) {
                    renderAttendanceTable(result.records);
                } else {
                    recordsContent.innerHTML = `
                        <div class="text-center" style="padding: 40px;">
                            <p style="color: var(--gray-500);">No attendance records found.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading records:', error);
                document.getElementById('recordsContent').innerHTML = `
                    <div class="text-center" style="padding: 40px;">
                        <p style="color: var(--error-color);">Error loading records. Please try again.</p>
                    </div>
                `;
            }
        }

        function renderAttendanceTable(records) {
            const recordsContent = document.getElementById('recordsContent');
            
            const tableHeaders = currentUser.role === 'admin' ? 
                ['Employee', 'Department', 'Date', 'Check In', 'Check Out', 'Hours', 'Type', 'Status', 'Office'] :
                ['Date', 'Check In', 'Check Out', 'Hours', 'Type', 'Status', 'Office'];

            const tableHTML = `
                <table class="records-table">
                    <thead>
                        <tr>
                            ${tableHeaders.map(header => `<th>${header}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(record => {
                            const totalHours = record.total_hours ? 
                                `${Math.floor(record.total_hours)}h ${Math.round((record.total_hours % 1) * 60)}m` : 
                                '-';
                            
                            const statusClass = `status-${record.status.replace('_', '')}`;
                            const statusText = record.status.replace('_', ' ').toUpperCase();
                            
                            const commonCells = [
                                record.date,
                                record.check_in_time || '-',
                                record.check_out_time || '-',
                                totalHours,
                                record.type.toUpperCase(),
                                `<span class="status-badge ${statusClass}">${statusText}</span>`,
                                record.office_name || '-'
                            ];

                            if (currentUser.role === 'admin') {
                                return `<tr>
                                    <td>${record.employee_name}</td>
                                    <td>${record.department}</td>
                                    ${commonCells.map(cell => `<td>${cell}</td>`).join('')}
                                </tr>`;
                            } else {
                                return `<tr>
                                    ${commonCells.map(cell => `<td>${cell}</td>`).join('')}
                                </tr>`;
                            }
                        }).join('')}
                    </tbody>
                </table>
            `;

            recordsContent.innerHTML = tableHTML;
        }

        // Export Functions
        async function exportToExcel() {
            if (currentUser.role !== 'admin') {
                showNotification('Export feature is available for admin users only', 'warning');
                return;
            }

            try {
                showNotification('Generating report...', 'success');

                const result = await apiCall('attendance-records', 'GET', {});

                if (!result.success || !result.records || result.records.length === 0) {
                    showNotification('No records to export', 'warning');
                    return;
                }

                // Create CSV content
                const headers = ['Employee Name', 'Department', 'Date', 'Check In', 'Check Out', 'Total Hours', 'Type', 'Status', 'Office'];
                const rows = result.records.map(record => [
                    record.employee_name || '',
                    record.department || '',
                    record.date || '',
                    record.check_in_time || '',
                    record.check_out_time || '',
                    record.total_hours ? record.total_hours.toFixed(1) : '0',
                    record.type ? record.type.toUpperCase() : '',
                    record.status ? record.status.replace('_', ' ').toUpperCase() : '',
                    record.office_name || ''
                ]);

                const csvContent = [headers, ...rows]
                    .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                    .join('\n');

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance_report_${getCurrentDateTime().date}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification('Report exported successfully!');
            } catch (error) {
                showNotification('Error exporting data', 'error');
                console.error('Export error:', error);
            }
        }

        // Modal Functions
        function showModal(modalId, message) {
            const modal = document.getElementById(modalId);
            
            if (modalId === 'successModal') {
                const messageEl = document.getElementById('successMessage');
                if (messageEl) messageEl.textContent = message;
                
                // Auto-close and redirect after 2 seconds
                setTimeout(() => {
                    closeModal(modalId);
                    showScreen('dashboardScreen');
                    loadDashboardData();
                }, 2000);
            }
            
            modal.classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Utility Functions
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Earth radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        (function(){
    // expose simple entry points used by HTML buttons
    window.openOfficeModal = () => {
        resetOfficeForm();
        document.getElementById('officeModal').classList.add('active');
    };
    window.openUserModal = () => {
        resetUserForm();
        document.getElementById('userModal').classList.add('active');
    };

    // load on screen show
    const originalShowScreen = window.showScreen;
    window.showScreen = function(screenId) {
        originalShowScreen(screenId);
        if (screenId === 'editOfficesCard') loadOffices();
        if (screenId === 'editUsersCard') loadUsers();
    };

    // Offices
    async function loadOffices() {
        const container = document.getElementById('officesAdminContent');
        container.innerHTML = `<div class="text-center" style="padding:20px;">
            <div class="loading-spinner" style="margin:0 auto 12px; width:24px; height:24px;"></div>
            <p>Loading offices...</p>
        </div>`;

        try {
            const res = await apiCall('offices', 'GET', { department: currentUser.department });
            if (!res.success) {
                container.innerHTML = `<p style="color:var(--error-color)">Failed to load offices</p>`;
                return;
            }

            if (!res.offices || res.offices.length === 0) {
                container.innerHTML = `<p>No offices found.</p>`;
                return;
            }

            const rows = res.offices.map(o => `
                <tr>
                    <td>${o.name}</td>
                    <td>${o.address || ''}</td>
                    <td>${o.latitude}, ${o.longitude}</td>
                    <td>${o.radius_meters}</td>
                    <td class="table-actions">
                        <button class="btn btn-secondary btn-icon" onclick='editOffice(${JSON.stringify(o).replace(/'/g,"\\'")})'>‚úèÔ∏è</button>
                        <button class="btn btn-secondary btn-icon" onclick="deleteOffice(${o.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');

            container.innerHTML = `<table class="admin-table">
                <thead><tr><th>Name</th><th>Address</th><th>Coordinates</th><th>Radius (m)</th><th>Actions</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>`;
        } catch (err) {
            console.error(err);
            container.innerHTML = `<p style="color:var(--error-color)">Error loading offices</p>`;
        }
    }

    window.editOffice = function(office) {
        // populate form
        document.getElementById('office_id').value = office.id || '';
        document.getElementById('office_name').value = office.name || '';
        document.getElementById('office_address').value = office.address || '';
        document.getElementById('office_lat').value = office.latitude || '';
        document.getElementById('office_lng').value = office.longitude || '';
        document.getElementById('office_radius').value = office.radius_meters || 100;
        document.getElementById('officeModal').classList.add('active');
    };

    function resetOfficeForm(){
        document.getElementById('officeForm').reset();
        document.getElementById('office_id').value = '';
    }

    window.saveOffice = async function(e){
        e.preventDefault();
        const id = document.getElementById('office_id').value;
        const payload = {
            id: id || undefined,
            name: document.getElementById('office_name').value,
            address: document.getElementById('office_address').value,
            latitude: parseFloat(document.getElementById('office_lat').value),
            longitude: parseFloat(document.getElementById('office_lng').value),
            radius_meters: parseInt(document.getElementById('office_radius').value, 10)
        };
        try {
            const endpoint = payload.id ? 'update-office' : 'add-office';
            const res = await apiCall(endpoint, 'POST', payload);
            if (res.success) {
                closeModal('officeModal');
                showNotification('Office saved');
                loadOffices();
            } else {
                showNotification(res.message || 'Save failed', 'error');
            }
        } catch (err) {
            console.error(err);
            showNotification('Save error', 'error');
        }
    };

    window.deleteOffice = async function(id){
        if (!confirm('Delete this office?')) return;
        try {
            const res = await apiCall('delete-office', 'POST', { id });
            if (res.success) {
                showNotification('Office deleted');
                loadOffices();
            } else {
                showNotification(res.message || 'Delete failed', 'error');
            }
        } catch (err) {
            console.error(err);
            showNotification('Delete error', 'error');
        }
    };

    // Users
    async function loadUsers() {
        const container = document.getElementById('usersAdminContent');
        container.innerHTML = `<div class="text-center" style="padding:20px;">
            <div class="loading-spinner" style="margin:0 auto 12px; width:24px; height:24px;"></div>
            <p>Loading users...</p>
        </div>`;

        try {
            const res = await apiCall('users', 'GET', {});
            if (!res.success) {
                container.innerHTML = `<p style="color:var(--error-color)">Failed to load users</p>`;
                return;
            }

            if (!res.users || res.users.length === 0) {
                container.innerHTML = `<p>No users found.</p>`;
                return;
            }

            const rows = res.users.map(u => `
                <tr>
                    <td>${u.name}</td>
                    <td>${u.username}</td>
                    <td>${u.email || ''}</td>
                    <td>${u.department || ''}</td>
                    <td>${u.role || 'employee'}</td>
                    <td class="table-actions">
                        <button class="btn btn-secondary btn-icon" onclick='editUser(${JSON.stringify(u).replace(/'/g,"\\'")})'>‚úèÔ∏è</button>
                        <button class="btn btn-secondary btn-icon" onclick="deleteUser(${u.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');

            container.innerHTML = `<table class="admin-table">
                <thead><tr><th>Name</th><th>Username</th><th>Email</th><th>Department</th><th>Role</th><th>Actions</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>`;
        } catch (err) {
            console.error(err);
            container.innerHTML = `<p style="color:var(--error-color)">Error loading users</p>`;
        }
    }

    window.editUser = function(user) {
        document.getElementById('user_id').value = user.id || '';
        document.getElementById('user_name').value = user.name || '';
        document.getElementById('user_username').value = user.username || '';
        document.getElementById('user_password').value = ''; // do not prefill password
        document.getElementById('user_email').value = user.email || '';
        document.getElementById('user_phone').value = user.phone || '';
        document.getElementById('user_department').value = user.department || '';
        document.getElementById('user_role').value = user.role || 'employee';
        document.getElementById('userModal').classList.add('active');
    };

    function resetUserForm(){
        document.getElementById('userForm').reset();
        document.getElementById('user_id').value = '';
    }

    window.saveUser = async function(e){
        e.preventDefault();
        const id = document.getElementById('user_id').value;
        const payload = {
            id: id || undefined,
            name: document.getElementById('user_name').value,
            username: document.getElementById('user_username').value,
            password: document.getElementById('user_password').value || undefined,
            email: document.getElementById('user_email').value,
            phone: document.getElementById('user_phone').value,
            department: document.getElementById('user_department').value,
            role: document.getElementById('user_role').value
        };
        try {
            const endpoint = payload.id ? 'update-user' : 'add-user';
            const res = await apiCall(endpoint, 'POST', payload);
            if (res.success) {
                closeModal('userModal');
                showNotification('User saved');
                loadUsers();
            } else {
                showNotification(res.message || 'Save failed', 'error');
            }
        } catch (err) {
            console.error(err);
            showNotification('Save error', 'error');
        }
    };

    window.deleteUser = async function(id){
        if (!confirm('Delete this user?')) return;
        try {
            const res = await apiCall('delete-user', 'POST', { id });
            if (res.success) {
                showNotification('User deleted');
                loadUsers();
            } else {
                showNotification(res.message || 'Delete failed', 'error');
            }
        } catch (err) {
            console.error(err);
            showNotification('Delete error', 'error');
        }
    };

    // expose load functions for manual use
    window.loadOffices = loadOffices;
    window.loadUsers = loadUsers;
})();
    </script>
</body>
</html>