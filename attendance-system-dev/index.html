<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance System - MySQL Powered</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-500: #64748b;
            --gray-700: #334155;
            --gray-900: #0f172a;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            min-height: 100vh;
            color: var(--gray-900);
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            border: 1px solid var(--gray-200);
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: var(--white);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
            text-align: center;
        }

        .login-subtitle {
            color: var(--gray-500);
            text-align: center;
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: var(--white);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            min-height: 48px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: var(--gray-500);
            color: var(--white);
        }

        .btn-success {
            background: var(--success-color);
            color: var(--white);
        }

        .btn-full-width {
            width: 100%;
        }

        .signup-link,
        .login-link {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--gray-200);
        }

        .signup-link a,
        .login-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .demo-credentials {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
            text-align: center;
            border: 1px solid var(--gray-200);
        }

        .demo-credentials h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .demo-credentials p {
            font-size: 14px;
            color: var(--gray-600);
            margin: 4px 0;
        }

        .header {
            background: var(--white);
            border-radius: 16px;
            padding: 20px 32px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-welcome {
            font-weight: 600;
            color: var(--gray-700);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .stat-card-value.success {
            color: var(--success-color);
        }

        .stat-card-value.warning {
            color: var(--warning-color);
        }

        .stat-card-value.error {
            color: var(--error-color);
        }

        .stat-card-timing {
            font-size: 14px;
            color: var(--gray-500);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .action-card {
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        .action-card-icon {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
        }

        .action-card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .action-card-description {
            color: var(--gray-500);
            font-size: 14px;
            line-height: 1.5;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .office-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }

        .office-card {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            position: relative;
        }

        .office-card:hover,
        .office-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
            transform: translateY(-2px);
        }

        .office-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .office-card h3 {
            color: var(--gray-900);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .office-card p {
            color: var(--gray-600);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .location-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .location-status.checking {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .location-status.in-range {
            background: #dcfce7;
            color: #166534;
        }

        .location-status.out-of-range {
            background: #fef3c7;
            color: #92400e;
        }

        .location-status.error {
            background: #fed7d7;
            color: #742a2a;
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 4/3;
        }

        .camera-container video,
        .camera-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .records-table th,
        .records-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .records-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 14px;
        }

        .records-table tr:hover {
            background: var(--gray-50);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-present {
            background: #dcfce7;
            color: #166534;
        }

        .status-wfh {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-half_day {
            background: #fef3c7;
            color: #92400e;
        }

        .status-client {
            background: #e0e7ff;
            color: #3730a3;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: var(--white);
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--error-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid,
            .actions-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .container {
                padding: 12px;
            }

            .office-selection {
                grid-template-columns: 1fr;
            }

            .camera-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-title">Employee Attendance System</div>
                <div class="login-subtitle">Sign in to mark your attendance</div>

                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="loginUsername" class="form-control" placeholder="Enter your username"
                            required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password"
                            required>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full-width" id="loginBtn">
                        <span id="loginBtnText">Sign In</span>
                        <span id="loginSpinner" class="loading-spinner hidden"></span>
                    </button>
                </form>

                <div class="signup-link">
                    <p>New employee? <a href="#" onclick="showScreen('signupScreen')">Sign up here</a></p>
                </div>

                <div class="demo-credentials">
                    <h4>Demo Credentials</h4>
                    <p><strong>Admin:</strong> admin / password</p>
                    <p><strong>Employee:</strong> john.doe / password</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Signup Screen -->
    <div id="signupScreen" class="screen">
        <div class="login-container">
            <div class="login-card" style="max-width: 600px;">
                <div class="login-title">Create Your Account</div>
                <div class="login-subtitle">Join our attendance system</div>

                <form onsubmit="handleSignup(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" id="signupName" class="form-control" placeholder="Enter full name"
                                required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" id="signupPhone" class="form-control" placeholder="10-digit number"
                                required pattern="[0-9]{10}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="signupEmail" class="form-control" placeholder="Enter email" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Department</label>
                            <select id="signupDepartment" class="form-control" required>
                                <option value="">Select Department</option>
                                <option value="IT">IT</option>
                                <option value="HR">HR</option>
                                <option value="Surveyors">Surveyors</option>
                                <option value="Accounts">Accounts</option>
                                <option value="Growth">Growth</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Primary Office</label>
                            <select id="signupOffice" class="form-control" required>
                                <option value="">Select Office</option>
                                <option value="79">79 Office</option>
                                <option value="105">105 Office</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" id="signupUsername" class="form-control" placeholder="Choose username"
                                required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" id="signupPassword" class="form-control"
                                placeholder="Create password" required minlength="6">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full-width" id="signupBtn">
                        <span id="signupBtnText">Create Account</span>
                        <span id="signupSpinner" class="loading-spinner hidden"></span>
                    </button>
                </form>

                <div class="login-link">
                    <p>Already have an account? <a href="#" onclick="showScreen('loginScreen')">Sign in here</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="screen">
        <div class="container">
            <div class="header">
                <div class="header-title">Attendance Dashboard</div>
                <div class="header-user">
                    <span class="user-welcome">Welcome, <span id="userName">User</span></span>
                    <button onclick="logout()" class="btn btn-secondary">Logout</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-title">Today's Status</div>
                    <div class="stat-card-value" id="todayStatus">Not Marked</div>
                    <div class="stat-card-timing" id="todayTiming"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">This Month</div>
                    <div class="stat-card-value" id="monthlyDays">0</div>
                    <div class="stat-card-timing">Working Days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">WFH Used</div>
                    <div class="stat-card-value" id="wfhCount">0/1</div>
                    <div class="stat-card-timing">This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">Location Status</div>
                    <div class="stat-card-value" id="locationStatus">Checking...</div>
                    <div class="stat-card-timing" id="locationDistance"></div>
                </div>
            </div>

            <div class="actions-grid">
                <div class="action-card" onclick="startAttendanceFlow()" id="checkInCard">
                    <span class="action-card-icon">üìç</span>
                    <div class="action-card-title">Check In</div>
                    <div class="action-card-description">Mark your attendance with location and photo</div>
                </div>
                <div class="action-card hidden" onclick="showCheckOut()" id="checkOutCard">
                    <span class="action-card-icon">üèÉ</span>
                    <div class="action-card-title">Check Out</div>
                    <div class="action-card-description">Complete your work day</div>
                </div>
                <div class="action-card" onclick="showScreen('recordsScreen')">
                    <span class="action-card-icon">üìã</span>
                    <div class="action-card-title">My Records</div>
                    <div class="action-card-description">View your attendance history</div>
                </div>
                <div class="action-card hidden" onclick="openAdminPanel()" id="adminCard">
                    <span class="action-card-icon">‚úçÔ∏è</span>
                    <div class="action-card-title">Admin Panel</div>
                    <div class="action-card-description">Add/Edit Users/Offices (Admin only)</div>
                </div>
                <div class="action-card" onclick="exportToExcel()" id="exportCard">
                    <span class="action-card-icon">üìä</span>
                    <div class="action-card-title">Export Attendance</div>
                    <div class="action-card-description">Download attendance records as Excel file (Admin only)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Screen -->
    <div id="attendanceScreen" class="screen">
        <div class="container">
            <div class="header">
                <div class="header-title">Mark Attendance</div>
                <button onclick="showScreen('dashboardScreen')" class="btn btn-secondary">‚Üê Back</button>
            </div>

            <div class="card">
                <!-- Choice row: WFH / Office / Client -->
                <div id="typeSelectionSection" style="margin-top: 8px;">
                    <h3>Select Attendance Type:</h3>
                    <div class="office-selection" id="typeSelection">
                        <!-- inside the WFH card -->
                        <div class="office-card" onclick="selectType('wfh', event)" id="wfhOption">
                            <span class="action-card-icon">üè†</span>
                            <h3>Work From Home</h3>
                            <p id="wfhStatus">Checking availability...</p>

                            <!-- add this line -->
                            <button id="wfhRequestBtn" class="btn btn-secondary" style="display:none; margin-top:8px;"
                                onclick="requestWFHExtension(event)">Request WFH</button>
                        </div>


                        <div class="office-card" onclick="selectType('office', event)">
                            <span class="action-card-icon">üè¢</span>
                            <h3>Office Work</h3>
                            <p>Shows offices after you tap</p>
                        </div>

                        <div class="office-card" onclick="selectType('client', event)">
                            <span class="action-card-icon">üìç</span>
                            <h3>Client Location</h3>
                            <p>No geofence required</p>
                        </div>
                    </div>
                </div>

                <!-- Offices (hidden until user picks ‚ÄúOffice Work‚Äù) -->
                <div id="officeBlock" style="display:none; margin-top: 24px;">
                    <h3>Select Office:</h3>
                    <p style="color: var(--gray-500); margin-bottom: 12px;">
                        Only offices within range will be enabled
                    </p>
                    <div class="office-selection" id="officeSelection">
                        <!-- populated by JS -->
                    </div>
                </div>

                <!-- Camera -->
                <div id="cameraSection" class="hidden" style="margin-top: 24px;">
                    <h3>Take Your Photo:</h3>
                    <p style="color: var(--gray-500); margin-bottom: 12px;">Photo is required for verification</p>

                    <div class="camera-container">
                        <video id="video" autoplay muted playsinline style="display:none;"></video>
                        <img id="capturedPhoto" style="display:none;">
                        <div id="cameraPlaceholder"
                            style="display:flex;align-items:center;justify-content:center;height:100%;background:#f3f4f6;color:#6b7280;">
                            Click "Start Camera" to begin
                        </div>
                    </div>

                    <div class="camera-controls">
                        <button onclick="startCamera()" class="btn btn-primary" id="startCameraBtn">üì∑ Start
                            Camera</button>
                        <button onclick="capturePhoto()" class="btn btn-success" id="captureBtn"
                            style="display:none;">üì∏ Capture</button>
                        <button onclick="retakePhoto()" class="btn btn-secondary" id="retakeBtn"
                            style="display:none;">üîÑ Retake</button>
                    </div>

                    <div class="text-center" style="margin-top: 16px;">
                        <button onclick="markAttendance()" class="btn btn-success" id="markBtn" style="display:none;">
                            <span id="markBtnText">‚úÖ Mark Attendance</span>
                            <span id="markSpinner" class="loading-spinner hidden"></span>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Records Screen -->
    <div id="recordsScreen" class="screen">
        <div class="container">
            <div class="header">
                <div class="header-title">Attendance Records</div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <span id="adminExportNote" class="hidden" style="color: var(--gray-500); font-size: 14px;">(Admin:
                        Export available)</span>
                    <button onclick="showScreen('dashboardScreen')" class="btn btn-secondary">‚Üê Back</button>
                </div>
            </div>

            <div class="card">
                <div id="recordsContent">
                    <div class="text-center" style="padding: 40px;">
                        <div class="loading-spinner" style="margin: 0 auto 16px; width: 24px; height: 24px;"></div>
                        <p>Loading attendance records...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Admin Panel -->
    <div id="adminScreen" class="screen">
        <div class="container">
            <div class="header">
                <div class="header-title">Admin Panel</div>
                <div style="display:flex; gap:12px; align-items:center;">
                    <button onclick="showScreen('dashboardScreen')" class="btn btn-secondary">‚Üê Back</button>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                <!-- Add Office -->
                <div class="card">
                    <h3 style="margin-bottom:12px;">Add New Office</h3>
                    <div class="form-group">
                        <label class="form-label">Office Name</label>
                        <input id="newOfficeName" class="form-control" placeholder="e.g., Head Office">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input id="newOfficeAddress" class="form-control" placeholder="Office address">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Latitude</label>
                            <input id="newOfficeLat" class="form-control" placeholder="e.g., 28.6139">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Longitude</label>
                            <input id="newOfficeLng" class="form-control" placeholder="e.g., 77.2090">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Radius (meters)</label>
                        <input id="newOfficeRadius" class="form-control" placeholder="e.g., 100">
                    </div>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <button class="btn btn-primary" onclick="submitNewOffice()">‚ûï Add Office</button>
                        <button class="btn" onclick="clearOfficeForm()">Reset</button>
                    </div>
                    <div id="addOfficeMsg" style="margin-top:8px;color:var(--gray-700);font-size:13px;"></div>
                </div>

                <!-- Add User -->
                <div class="card">
                    <h3 style="margin-bottom:12px;">Add New User</h3>
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input id="newUserName" class="form-control" placeholder="e.g., John Doe">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input id="newUserUsername" class="form-control" placeholder="username">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mobile Number</label>
                            <input id="newUserPhone" class="form-control" placeholder="10-digit number">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input id="newUserEmail" class="form-control" placeholder="email@example.com">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Department</label>
                            <select id="newUserDepartment" class="form-control">
                                <option value="">Select Department</option>
                                <option>IT</option>
                                <option>HR</option>
                                <option>Surveyors</option>
                                <option>Accounts</option>
                                <option>Growth</option>
                                <option>Others</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Primary Office</label>
                            <select id="newUserPrimaryOffice" class="form-control">
                                <option value="">Loading offices‚Ä¶</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Role</label>
                            <select id="newUserRole" class="form-control">
                                <option value="employee">Employee</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input id="newUserPassword" type="password" class="form-control" placeholder="min 6 chars">
                        </div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-success" onclick="submitNewUser()">‚ûï Add User</button>
                        <button class="btn" onclick="clearUserForm()">Reset</button>
                    </div>
                    <div id="addUserMsg" style="margin-top:8px;color:var(--gray-700);font-size:13px;"></div>
                </div>
            </div>

            <!-- Lists -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <div class="card">
                    <h3>Offices <small id="officeCount" style="color:var(--gray-500); font-size:14px;"></small></h3>
                    <div id="adminOfficesList" style="margin-top:12px;"></div>
                </div>

                <div class="card">
                    <h3>Users Management <small id="userCount" style="color:var(--gray-500); font-size:14px;"></small>
                    </h3>
                    <div id="adminUsersListWrapper" style="margin-top:12px; overflow:auto; max-height:420px;">
                        <table id="adminUsersTable" class="records-table" style="width:100%;">
                            <thead>
                                <tr>
                                    <th style="width:60px">ID</th>
                                    <th>Name</th>
                                    <th>Username</th>
                                    <th>Mobile</th>
                                    <th>Department</th>
                                    <th>Role</th>
                                    <th style="width:160px">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminUsersList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="text-center">
                <div style="font-size: 64px; margin-bottom: 16px;">‚úÖ</div>
                <h3 style="margin-bottom: 16px;">Success!</h3>
                <p id="successMessage" style="margin-bottom: 24px;">Operation completed successfully.</p>
                <button onclick="closeModal('successModal')" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Check Out Confirmation Modal -->
    <div id="checkOutModal" class="modal">
        <div class="modal-content">
            <div class="text-center">
                <div style="font-size: 48px; margin-bottom: 16px;">üèÉ</div>
                <h3 style="margin-bottom: 16px;">Check Out Confirmation</h3>
                <div id="checkOutDetails" style="margin-bottom: 24px; text-align: left;"></div>
                <div id="halfDayWarning" class="hidden"
                    style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 20px; color: #92400e;">
                    <h4>‚ö†Ô∏è Half Day Warning</h4>
                    <p>You have worked less than 8 hours. This will be marked as a half day.</p>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button onclick="closeModal('checkOutModal')" class="btn btn-secondary">Cancel</button>
                    <button onclick="confirmCheckOut()" class="btn btn-primary" id="confirmCheckOutBtn">
                        <span id="checkOutBtnText">Confirm Check Out</span>
                        <span id="checkOutSpinner" class="loading-spinner hidden"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Global Variables
        let currentUser = null;
        let selectedOffice = null;
        let selectedType = null;
        let capturedPhotoData = null;
        let stream = null;
        let accessibleOffices = [];

        // API Configuration
        const API_BASE_URL = `http://localhost/New%20folder/attendance-system-dev/api.php`;

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function () {
            console.log('MySQL Attendance System Initializing...');

            // Check for stored user session
            const storedUser = localStorage.getItem('attendanceUser');
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    showScreen('dashboardScreen');
                    loadDashboardData();
                } catch (e) {
                    localStorage.removeItem('attendanceUser');
                }
            }
        });

        // Utility Functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');

            // Screen-specific initialization
            if (screenId === 'recordsScreen') {
                loadAttendanceRecords();
            } else if (screenId === 'attendanceScreen') {
                resetAttendanceFlow();
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => notification.classList.remove('show'), 4000);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatTime(date) {
            return date.toTimeString().split(' ')[0].substring(0, 5);
        }

        function getCurrentDateTime() {
            const now = new Date();
            return {
                date: formatDate(now),
                time: formatTime(now)
            };
        }
        const apiBaseUrl = (function () {

            return './api.php';
        })();
        // API Functions
        // Robust apiCall: uses query-style endpoint: /api.php?endpoint=attendance-records
        async function apiCall(path, method = 'GET', data = null) {
            method = (method || 'GET').toUpperCase();
            let url = apiBaseUrl + '?endpoint=' + encodeURIComponent(path);

            if (method === 'GET' && data && typeof data === 'object') {
                const qs = Object.keys(data).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(data[k])).join('&');
                if (qs) url += '&' + qs;
            }

            const opts = { method, headers: {} };
            if (method !== 'GET' && data !== null) {
                opts.headers['Content-Type'] = 'application/json';
                opts.body = JSON.stringify(data);
            }

            try {
                const res = await fetch(url, opts);
                const text = await res.text();
                try { return JSON.parse(text); } catch (e) { console.error('Non-JSON response', url, text); return { success: false, raw: text, status: res.status }; }
            } catch (err) { console.error('Fetch error', err); return { success: false, message: 'Network error', error: err }; }
        }



        // Authentication Functions
        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginSpinner = document.getElementById('loginSpinner');

            if (!username || !password) {
                showNotification('Please enter username and password', 'error');
                return;
            }

            // Show loading state
            loginBtn.disabled = true;
            loginBtnText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');

            try {
                const result = await apiCall('login', 'POST', {
                    username: username,
                    password: password
                });

                if (result.success) {
                    currentUser = result.user;
                    localStorage.setItem('attendanceUser', JSON.stringify(currentUser));

                    showNotification('Login successful!');
                    showScreen('dashboardScreen');
                    await loadDashboardData();
                } else {
                    showNotification(result.message || 'Login failed', 'error');
                }
            } finally {
                // Reset button state
                loginBtn.disabled = false;
                loginBtnText.classList.remove('hidden');
                loginSpinner.classList.add('hidden');
            }
        }

        async function handleSignup(event) {
            event.preventDefault();

            const formData = {
                name: document.getElementById('signupName').value,
                phone: document.getElementById('signupPhone').value,
                email: document.getElementById('signupEmail').value,
                department: document.getElementById('signupDepartment').value,
                primary_office: document.getElementById('signupOffice').value,
                username: document.getElementById('signupUsername').value,
                password: document.getElementById('signupPassword').value
            };

            const signupBtn = document.getElementById('signupBtn');
            const signupBtnText = document.getElementById('signupBtnText');
            const signupSpinner = document.getElementById('signupSpinner');

            // Show loading state
            signupBtn.disabled = true;
            signupBtnText.classList.add('hidden');
            signupSpinner.classList.remove('hidden');

            try {
                const result = await apiCall('register', 'POST', formData);

                if (result.success) {
                    showNotification('Account created successfully! Please login.');
                    showScreen('loginScreen');

                    // Clear form
                    Object.keys(formData).forEach(key => {
                        const element = document.getElementById(`signup${key.charAt(0).toUpperCase()}${key.slice(1).replace('_', '')}`);
                        if (element) element.value = '';
                    });
                } else {
                    showNotification(result.message || 'Registration failed', 'error');
                }
            } finally {
                // Reset button state
                signupBtn.disabled = false;
                signupBtnText.classList.remove('hidden');
                signupSpinner.classList.add('hidden');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('attendanceUser');
            showNotification('Logged out successfully');
            showScreen('loginScreen');
        }

        // Dashboard Functions
        async function loadDashboardData() {
            if (!currentUser) return;

            document.getElementById('userName').textContent = currentUser.name;

            // Show admin features for admin users
            if (currentUser.role === 'admin') {
                document.getElementById('adminCard').classList.remove('hidden');
                document.getElementById('adminExportNote').classList.remove('hidden');
            }

            // Load data in parallel
            await Promise.all([
                loadTodayAttendance(),
                loadMonthlyStats(),
                loadWFHEligibility(),
                updateLocationStatus()
            ]);
        }

        async function loadTodayAttendance() {
            try {
                const result = await apiCall('today-attendance', 'GET', {
                    employee_id: currentUser.id
                });

                const statusElement = document.getElementById('todayStatus');
                const timingElement = document.getElementById('todayTiming');
                const checkInCard = document.getElementById('checkInCard');
                const checkOutCard = document.getElementById('checkOutCard');

                if (result.success && result.record) {
                    const record = result.record;

                    if (record.check_out_time) {
                        statusElement.textContent = 'Completed';
                        statusElement.className = 'stat-card-value success';
                        timingElement.textContent = `${record.check_in_time} - ${record.check_out_time}`;
                        checkInCard.classList.add('hidden');
                        checkOutCard.classList.add('hidden');
                    } else {
                        statusElement.textContent = 'Checked In';
                        statusElement.className = 'stat-card-value success';
                        timingElement.textContent = `Since ${record.check_in_time}`;
                        checkInCard.classList.add('hidden');
                        checkOutCard.classList.remove('hidden');
                    }
                } else {
                    statusElement.textContent = 'Not Marked';
                    statusElement.className = 'stat-card-value error';
                    timingElement.textContent = '';
                    checkInCard.classList.remove('hidden');
                    checkOutCard.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading today attendance:', error);
            }
        }

        async function loadMonthlyStats() {
            try {
                const result = await apiCall('monthly-stats', 'GET', {
                    employee_id: currentUser.id
                });

                const monthlyDaysElement = document.getElementById('monthlyDays');
                if (result.success && result.stats) {
                    monthlyDaysElement.textContent = result.stats.total_days || 0;
                }
            } catch (error) {
                console.error('Error loading monthly stats:', error);
            }
        }

        async function loadWFHEligibility() {
            try {
                const result = await apiCall('wfh-eligibility', 'GET', {
                    employee_id: currentUser.id,
                    date: getCurrentDateTime().date
                });

                const wfhCountElement = document.getElementById('wfhCount');
                if (result) {
                    const currentCount = result.current_count || 0;
                    const maxLimit = result.max_limit || 1;

                    wfhCountElement.textContent = `${currentCount}/${maxLimit}`;

                    if (currentCount >= maxLimit) {
                        wfhCountElement.className = 'stat-card-value warning';
                    } else {
                        wfhCountElement.className = 'stat-card-value success';
                    }
                }
            } catch (error) {
                console.error('Error loading WFH eligibility:', error);
            }
        }

        // If your code calls updateLocationStatus(), forward it to checkAndUpdateLocationStatus()
        async function updateLocationStatus() {
            if (typeof checkAndUpdateLocationStatus === 'function') {
                return await checkAndUpdateLocationStatus();
            }
            return null;
        }



        // Replace these functions in your script with the versions below.

        /* ===== loadOfficeSelection ===== */
        async function loadOfficeSelection() {
            try {
                const result = await apiCall('offices', 'GET', {
                    department: currentUser.department
                });

                if (!result.success) {
                    showNotification('Failed to load office information', 'error');
                    return;
                }

                accessibleOffices = result.offices;
                const container = document.getElementById('officeSelection');

                if (accessibleOffices.length === 0) {
                    container.innerHTML = '<p>No offices accessible for your department.</p>';
                    return;
                }

                container.innerHTML = '';

                // Try to get user location to show distances, but render cards even if location fails.
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            await renderOfficeCards(position.coords.latitude, position.coords.longitude);
                        },
                        () => {
                            // Render without precise distances / location check
                            renderOfficeCardsWithoutLocation();
                        },
                        { timeout: 5000 }
                    );
                } else {
                    renderOfficeCardsWithoutLocation();
                }

                // Ensure the Type selection (including WFH) is visible even BEFORE an office is selected
                // so users can choose WFH directly. We will keep it hidden visually until after the
                // user clicks a card to preserve UI flow, but we will not block WFH selection in code.
                document.getElementById('typeSelectionSection').classList.add('hidden');
            } catch (error) {
                showNotification('Error loading offices', 'error');
                console.error('Error:', error);
            }
        }

        /* ===== renderOfficeCards ===== */
        async function renderOfficeCards(userLat, userLng) {
            const container = document.getElementById('officeSelection');
            container.innerHTML = '';

            for (const office of accessibleOffices) {
                const distance = (typeof userLat === 'number' && typeof userLng === 'number')
                    ? calculateDistance(userLat, userLng, parseFloat(office.latitude), parseFloat(office.longitude))
                    : null;

                const inRange = distance !== null ? (distance <= office.radius_meters) : false;
                // Visual class still indicates disabled, but card remains clickable.
                const cardClass = 'office-card' + (inRange ? '' : ''); // remove 'disabled' so it's clickable

                const officeCard = document.createElement('div');
                officeCard.className = cardClass;
                officeCard.innerHTML = `
            <span class="action-card-icon">üè¢</span>
            <h3>${office.name}</h3>
            <p>${office.address || ''}</p>
            <div class="location-status ${inRange ? 'in-range' : 'out-of-range'}">
                ${inRange ? 'In Range' : 'Out of Range'}${distance !== null ? ` (${Math.round(distance)}m)` : ''}
            </div>
        `;

                // Always attach onclick so user can choose any office (even out-of-range).
                officeCard.onclick = (e) => selectOffice(e, office.id);

                container.appendChild(officeCard);
            }

            // Also ensure the WFH option is updated (keeps eligibility logic separate)
            await updateWFHOption();
        }

        /* ===== renderOfficeCardsWithoutLocation ===== */
        function renderOfficeCardsWithoutLocation() {
            const container = document.getElementById('officeSelection');
            container.innerHTML = '';

            accessibleOffices.forEach(office => {
                const officeCard = document.createElement('div');
                officeCard.className = 'office-card';
                officeCard.innerHTML = `
            <span class="action-card-icon">üè¢</span>
            <h3>${office.name}</h3>
            <p>${office.address || ''}</p>
            <div class="location-status checking">Location check unavailable</div>
        `;

                // Still allow selecting an office even when location is unavailable.
                officeCard.onclick = (e) => selectOffice(e, office.id);
                container.appendChild(officeCard);
            });

            // Update WFH option as well
            updateWFHOption().catch(err => console.error(err));
        }

        /* ===== selectOffice =====
           Accept event explicitly (to safely use event.target), and always show type selection.
        */
        async function selectOffice(e, officeId) {
            // store chosen office (can be out-of-range); for WFH user may later choose WFH which will set selectedOffice to null
            selectedOffice = officeId;

            // Update UI selection highlight
            document.querySelectorAll('#officeSelection .office-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Find the clicked card element robustly
            let cardEl = e.target;
            // climb up to the office-card container
            while (cardEl && !cardEl.classList.contains('office-card')) {
                cardEl = cardEl.parentElement;
            }
            if (cardEl) cardEl.classList.add('selected');

            // Show type selection regardless of range ‚Äî user can pick WFH (which sets selectedOffice = null)
            document.getElementById('typeSelectionSection').classList.remove('hidden');

            // Refresh WFH eligibility text/button (limit-based)
            await updateWFHOption();
        }

        /* ===== selectType =====
           Accept event explicitly; allow WFH without an office (selectedOffice will be null for WFH).
        */
        function selectType(type, e) {
            // If WFH is selected and the WFH option shows disabled (limit reached), prevent selection
            if (type === 'wfh') {
                const wfhOption = document.getElementById('wfhOption');
                if (wfhOption.classList.contains('disabled')) {
                    return;
                }
                // For WFH clear selectedOffice (office_id will be null in attendance payload)
                selectedOffice = null;
            }

            selectedType = type;

            // Update UI selection highlight for types
            document.querySelectorAll('#typeSelection .office-card').forEach(card => {
                card.classList.remove('selected');
            });

            // get the clicked card element and mark it selected
            let cardEl = e ? e.target : null;
            if (cardEl) {
                while (cardEl && !cardEl.classList.contains('office-card')) {
                    cardEl = cardEl.parentElement;
                }
                if (cardEl) cardEl.classList.add('selected');
            }

            // Show camera section
            document.getElementById('cameraSection').classList.remove('hidden');
        }


        // Attendance Flow Functions
        // ===== Attendance & Camera: CLEAN CONSOLIDATED BLOCK =====

        // Globals expected: currentUser, selectedOffice, selectedType, capturedPhotoData, stream, accessibleOffices

        /* Entry point when user clicks ‚ÄúCheck In‚Äù */
        async function startAttendanceFlow() {
            showScreen('attendanceScreen');
            if (typeof resetAttendanceFlow === 'function') resetAttendanceFlow();

            // show three choices first
            document.getElementById('typeSelectionSection').classList.remove('hidden');
            const officeBlock = document.getElementById('officeBlock');
            if (officeBlock) officeBlock.style.display = 'none';
            document.getElementById('cameraSection').classList.add('hidden');

            // preload offices + compute if user is inside any geofence (to toggle WFH)
            try {
                await loadOfficesForProximity();
            } catch (e) {
                console.warn('Proximity preload failed:', e);
                updateWFHOption({ inAnyOfficeRange: false, checked: false });
            }
        }

        /* Preload offices & compute geofence membership (for WFH availability) */
        async function loadOfficesForProximity() {
            if (!currentUser) return;

            const res = await apiCall('offices', 'GET', { department: currentUser.department });
            accessibleOffices = (res && res.success && Array.isArray(res.offices)) ? res.offices : [];

            if (!navigator.geolocation) {
                updateWFHOption({ inAnyOfficeRange: false, checked: false });
                return;
            }

            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const lat = pos.coords.latitude, lng = pos.coords.longitude;
                    let inAny = false;
                    for (const o of accessibleOffices) {
                        const d = calculateDistance(lat, lng, parseFloat(o.latitude), parseFloat(o.longitude));
                        if (d <= (o.radius_meters || 0)) { inAny = true; break; }
                    }
                    updateWFHOption({ inAnyOfficeRange: inAny, checked: true });
                    resolve();
                }, () => {
                    updateWFHOption({ inAnyOfficeRange: false, checked: false });
                    resolve();
                }, { timeout: 6000 });
            });
        }

        /* Update WFH card: disable if inside office geofence; show Request button if monthly limit reached */
        function updateWFHOption(state = { inAnyOfficeRange: false, checked: false }) {
            const wfhOption = document.getElementById('wfhOption');
            const wfhStatus = document.getElementById('wfhStatus');
            const wfhRequestBtn = document.getElementById('wfhRequestBtn');

            // default hide Request button
            if (wfhRequestBtn) wfhRequestBtn.style.display = 'none';

            // also check server monthly limit (non-blocking)
            apiCall('wfh-eligibility', 'GET', {
                employee_id: currentUser.id,
                date: getCurrentDateTime().date
            }).then(result => {
                if (result && typeof result.current_count === 'number') {
                    // if limit reached, offer request button
                    if (result.max_limit && result.current_count >= result.max_limit) {
                        if (wfhRequestBtn) wfhRequestBtn.style.display = 'inline-flex';
                    }
                }
            }).catch(() => { });

            if (!state.checked) {
                // could not get location -> allow WFH but mark unknown
                wfhOption.classList.remove('disabled');
                wfhStatus.textContent = 'Availability unknown (no location)';
                wfhStatus.style.color = 'var(--warning-color)';
                return;
            }

            if (state.inAnyOfficeRange) {
                // inside geofence -> WFH disabled
                wfhOption.classList.add('disabled');
                wfhStatus.textContent = 'Not allowed while at office';
                wfhStatus.style.color = 'var(--error-color)';
            } else {
                // outside geofence -> WFH allowed (server still enforces monthly limit on submit)
                wfhOption.classList.remove('disabled');
                wfhStatus.textContent = 'Available';
                wfhStatus.style.color = 'var(--success-color)';
            }
        }

        /* Optional: send a WFH extension request to Admin/HR (email fallback if no API) */
        async function requestWFHExtension(ev) {
            ev && ev.stopPropagation && ev.stopPropagation();
            const note = prompt('Add a short note for Admin/HR (optional):', '');
            if (note === null) return;

            try {
                const res = await apiCall('wfh-request', 'POST', {
                    employee_id: currentUser.id,
                    date: getCurrentDateTime().date,
                    reason: note
                });
                if (res && res.success) {
                    showNotification('WFH request sent to Admin/HR', 'success');
                    return;
                }
            } catch { }

            // fallback to mail
            const mailto = `mailto:hr@example.com?subject=WFH%20Request&body=${encodeURIComponent(
                `Employee: ${currentUser.name} (#${currentUser.id})%0D%0ADate: ${getCurrentDateTime().date}%0D%0AReason: ${note}`
            )}`;
            window.location.href = mailto;
            showNotification('Opening your mail app to send the request.');
        }

        /* When user taps WFH / Office / Client */
        function selectType(type, e) {
            // block if WFH disabled (inside geofence)
            if (type === 'wfh' && document.getElementById('wfhOption').classList.contains('disabled')) {
                showNotification('You are within an office geofence. WFH is not allowed.', 'warning');
                return;
            }
            selectedType = type;

            // highlight the chosen card
            document.querySelectorAll('#typeSelection .office-card').forEach(c => c.classList.remove('selected'));
            if (e && e.target) {
                let el = e.target;
                while (el && !el.classList.contains('office-card')) el = el.parentElement;
                if (el) el.classList.add('selected');
            }

            if (type === 'office') {
                document.getElementById('officeBlock').style.display = 'grid';
                loadOfficeSelection();
                document.getElementById('cameraSection').classList.add('hidden');
            } else {
                // WFH / Client -> no office list
                selectedOffice = null;
                document.getElementById('officeBlock').style.display = 'none';
                document.getElementById('cameraSection').classList.remove('hidden');
            }
        }

        /* Build office cards (called only after user picks Office Work) */
        async function loadOfficeSelection() {
            const container = document.getElementById('officeSelection');
            container.innerHTML = '<div class="text-center" style="padding:16px;">Loading offices‚Ä¶</div>';

            if (!accessibleOffices || accessibleOffices.length === 0) {
                const res = await apiCall('offices', 'GET', { department: currentUser.department });
                accessibleOffices = (res && res.success) ? (res.offices || []) : [];
            }

            if (accessibleOffices.length === 0) {
                container.innerHTML = '<p style="color:var(--gray-600)">No offices found.</p>';
                return;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => renderOfficeCards(pos.coords.latitude, pos.coords.longitude),
                    () => renderOfficeCardsWithoutLocation(),
                    { timeout: 6000 }
                );
            } else {
                renderOfficeCardsWithoutLocation();
            }
        }

        function renderOfficeCards(userLat, userLng) {
            const container = document.getElementById('officeSelection');
            container.innerHTML = '';

            for (const o of accessibleOffices) {
                const d = calculateDistance(userLat, userLng, parseFloat(o.latitude), parseFloat(o.longitude));
                const inRange = d <= (o.radius_meters || 0);

                const card = document.createElement('div');
                card.className = 'office-card' + (inRange ? '' : ' disabled');
                card.innerHTML = `
      <span class="action-card-icon">üè¢</span>
      <h3>${o.name}</h3>
      <p>${o.address || ''}</p>
      <div class="location-status ${inRange ? 'in-range' : 'out-of-range'}">
        ${inRange ? 'In Range' : 'Out of Range'} (${Math.round(d)}m)
      </div>
    `;
                card.onclick = inRange
                    ? (ev) => selectOffice(ev, o.id)
                    : () => showNotification('You are not within this office geofence', 'warning');

                container.appendChild(card);
            }
        }

        function renderOfficeCardsWithoutLocation() {
            const container = document.getElementById('officeSelection');
            container.innerHTML = '';
            for (const o of accessibleOffices) {
                const card = document.createElement('div');
                card.className = 'office-card';
                card.innerHTML = `
      <span class="action-card-icon">üè¢</span>
      <h3>${o.name}</h3>
      <p>${o.address || ''}</p>
      <div class="location-status checking">Location check unavailable</div>
    `;
                card.onclick = (ev) => selectOffice(ev, o.id);
                container.appendChild(card);
            }
        }

        function selectOffice(e, officeId) {
            selectedOffice = officeId;
            document.querySelectorAll('#officeSelection .office-card').forEach(c => c.classList.remove('selected'));
            let el = e.target;
            while (el && !el.classList.contains('office-card')) el = el.parentElement;
            if (el) el.classList.add('selected');

            // after choosing an office, show camera
            document.getElementById('cameraSection').classList.remove('hidden');
        }

        /* Camera (robust) */
        function startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification('Camera not supported on this device', 'error');
                return;
            }
            navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
                audio: false
            }).then(mediaStream => {
                stream = mediaStream;
                const video = document.getElementById('video');
                video.srcObject = mediaStream;
                video.style.display = 'block';
                document.getElementById('cameraPlaceholder').style.display = 'none';
                document.getElementById('startCameraBtn').style.display = 'none';
                document.getElementById('captureBtn').style.display = 'inline-block';
            }).catch(() => showNotification('Camera access denied. Use https or http://localhost.', 'error'));
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const capturedImg = document.getElementById('capturedPhoto');

            if (!video || !video.videoWidth) {
                showNotification('Camera not ready yet', 'warning');
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            capturedPhotoData = canvas.toDataURL('image/jpeg', 0.7);
            capturedImg.src = capturedPhotoData;
            capturedImg.style.display = 'block';
            video.style.display = 'none';

            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'inline-block';
            document.getElementById('markBtn').style.display = 'inline-block';

            if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
        }

        function retakePhoto() {
            capturedPhotoData = null;
            document.getElementById('capturedPhoto').style.display = 'none';
            document.getElementById('cameraPlaceholder').style.display = 'flex';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('markBtn').style.display = 'none';
            document.getElementById('startCameraBtn').style.display = 'inline-block';
        }

        /* Final submit */
        async function markAttendance() {
            if (!selectedType) return showNotification('Please select WFH / Office / Client', 'error');
            if (selectedType === 'office' && !selectedOffice) return showNotification('Please select an office', 'error');
            if (!capturedPhotoData) return showNotification('Please capture a photo', 'error');

            const markBtn = document.getElementById('markBtn');
            const markBtnText = document.getElementById('markBtnText');
            const markSpinner = document.getElementById('markSpinner');
            markBtn.disabled = true; markBtnText.classList.add('hidden'); markSpinner.classList.remove('hidden');

            try {
                const now = getCurrentDateTime();

                // Optional location for Office/Client
                let loc = null;
                if ((selectedType === 'office' || selectedType === 'client') && navigator.geolocation) {
                    try {
                        const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { timeout: 7000 }));
                        loc = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
                    } catch { }
                }

                const payload = {
                    employee_id: currentUser.id,
                    date: now.date,
                    check_in: now.time,
                    type: selectedType,
                    status: selectedType === 'office' ? 'present' : selectedType,
                    office_id: selectedType === 'office' ? selectedOffice : null,
                    location: loc,
                    photo: capturedPhotoData
                };

                const r = await apiCall('mark-attendance', 'POST', payload);
                if (r && r.success) {
                    showNotification('Attendance marked successfully');
                    if (typeof resetAttendanceFlow === 'function') resetAttendanceFlow();
                    if (typeof loadDashboardData === 'function') await loadDashboardData();
                    showScreen('dashboardScreen');
                } else {
                    showNotification((r && r.message) || 'Failed to mark attendance', 'error');
                }
            } finally {
                markBtn.disabled = false; markBtnText.classList.remove('hidden'); markSpinner.classList.add('hidden');
            }
        }

        // (Optional) Keep this shim if something calls updateLocationStatus()
        async function updateLocationStatus() {
            if (typeof checkAndUpdateLocationStatus === 'function') {
                return await checkAndUpdateLocationStatus();
            }
            return null;
        }
        //----------------------------------------------------------------------
        // Check-out Functions
        async function showCheckOut() {
            try {
                const result = await apiCall('today-attendance', 'GET', {
                    employee_id: currentUser.id
                });

                if (!result.success || !result.record) {
                    showNotification('No check-in record found for today', 'error');
                    return;
                }

                const record = result.record;
                const checkInTime = new Date(`${record.date}T${record.check_in_time}`);
                const now = new Date();
                const workHours = (now - checkInTime) / (1000 * 60 * 60);

                // Populate modal
                const detailsDiv = document.getElementById('checkOutDetails');
                detailsDiv.innerHTML = `
                    <div style="margin-bottom: 12px;"><strong>Office:</strong> ${record.office_name || 'N/A'}</div>
                    <div style="margin-bottom: 12px;"><strong>Check In:</strong> ${record.check_in_time}</div>
                    <div style="margin-bottom: 12px;"><strong>Current Time:</strong> ${getCurrentDateTime().time}</div>
                    <div style="margin-bottom: 12px;"><strong>Work Hours:</strong> ${Math.floor(workHours)}h ${Math.round((workHours % 1) * 60)}m</div>
                `;

                const halfDayWarning = document.getElementById('halfDayWarning');
                if (workHours < 8) {
                    halfDayWarning.classList.remove('hidden');
                } else {
                    halfDayWarning.classList.add('hidden');
                }

                document.getElementById('checkOutModal').classList.add('active');
            } catch (error) {
                showNotification('Error loading check-in information', 'error');
                console.error('Error:', error);
            }
        }

        async function confirmCheckOut() {
            const confirmBtn = document.getElementById('confirmCheckOutBtn');
            const checkOutBtnText = document.getElementById('checkOutBtnText');
            const checkOutSpinner = document.getElementById('checkOutSpinner');

            // Show loading state
            confirmBtn.disabled = true;
            checkOutBtnText.classList.add('hidden');
            checkOutSpinner.classList.remove('hidden');

            try {
                const currentTime = getCurrentDateTime();

                // Get current location
                let location = null;
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                        });
                        location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                    } catch (error) {
                        console.warn('Could not get location for check-out:', error);
                    }
                }

                const result = await apiCall('check-out', 'POST', {
                    employee_id: currentUser.id,
                    date: currentTime.date,
                    check_out: currentTime.time,
                    location: location
                });

                if (result.success) {
                    let message = 'Check-out recorded successfully!';
                    if (result.is_half_day) {
                        message += ` (Marked as half day - ${result.work_hours.toFixed(1)} hours)`;
                    }

                    showNotification(message);
                    closeModal('checkOutModal');
                    loadDashboardData();
                } else {
                    showNotification(result.message || 'Failed to record check-out', 'error');
                }
            } catch (error) {
                showNotification('Error recording check-out', 'error');
                console.error('Error:', error);
            } finally {
                // Reset button state
                confirmBtn.disabled = false;
                checkOutBtnText.classList.remove('hidden');
                checkOutSpinner.classList.add('hidden');
            }
        }

        // Records Functions
        async function loadAttendanceRecords() {
            try {
                const recordsContent = document.getElementById('recordsContent');

                // Show loading
                recordsContent.innerHTML = `
                    <div class="text-center" style="padding: 40px;">
                        <div class="loading-spinner" style="margin: 0 auto 16px; width: 24px; height: 24px;"></div>
                        <p>Loading attendance records...</p>
                    </div>
                `;

                // Determine which records to load
                const params = {};
                if (currentUser.role !== 'admin') {
                    params.employee_id = currentUser.id;
                }

                const result = await apiCall('attendance-records', 'GET', params);

                if (result.success && result.records && result.records.length > 0) {
                    renderAttendanceTable(result.records);
                } else {
                    recordsContent.innerHTML = `
                        <div class="text-center" style="padding: 40px;">
                            <p style="color: var(--gray-500);">No attendance records found.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading records:', error);
                document.getElementById('recordsContent').innerHTML = `
                    <div class="text-center" style="padding: 40px;">
                        <p style="color: var(--error-color);">Error loading records. Please try again.</p>
                    </div>
                `;
            }
        }

        function renderAttendanceTable(records) {
            const recordsContent = document.getElementById('recordsContent');

            const tableHeaders = currentUser.role === 'admin' ?
                ['Employee', 'Department', 'Date', 'Check In', 'Check Out', 'Hours', 'Type', 'Status', 'Office'] :
                ['Date', 'Check In', 'Check Out', 'Hours', 'Type', 'Status', 'Office', 'Image'];

            const tableHTML = `
                <table class="records-table">
                    <thead>
                        <tr>
                            ${tableHeaders.map(header => `<th>${header}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(record => {
                const totalHours = record.total_hours ?
                    `${Math.floor(record.total_hours)}h ${Math.round((record.total_hours % 1) * 60)}m` :
                    '-';

                const statusClass = `status-${record.status.replace('_', '')}`;
                const statusText = record.status.replace('_', ' ').toUpperCase();

                const commonCells = [
                    record.date,
                    record.check_in_time || '-',
                    record.check_out_time || '-',
                    totalHours,
                    record.type.toUpperCase(),
                    `<span class="status-badge ${statusClass}">${statusText}</span>`,
                    record.office_name || '-'
                ];

                if (currentUser.role === 'admin') {
                    return `<tr>
                                    <td>${record.employee_name}</td>
                                    <td>${record.department}</td>
                                    ${commonCells.map(cell => `<td>${cell}</td>`).join('')}
                                </tr>`;
                } else {
                    return `<tr>
                                    ${commonCells.map(cell => `<td>${cell}</td>`).join('')}
                                </tr>`;
                }
            }).join('')}
                    </tbody>
                </table>
            `;

            recordsContent.innerHTML = tableHTML;
        }

        /* ===== Admin panel ===== */

        async function openAdminPanel() {
            // show panel and refresh lists
            showScreen('adminScreen');
            await refreshAdminOffices();    // loads offices into lists and selects
            await refreshAdminUsers();
        }

        async function refreshAdminOffices() {
            const listContainer = document.getElementById('adminOfficesList');
            const selectEl = document.getElementById('newUserPrimaryOffice');
            listContainer.innerHTML = 'Loading offices...';
            selectEl.innerHTML = '<option value="">Loading offices‚Ä¶</option>';
            document.getElementById('officeCount').textContent = '';

            // Try endpoint candidates (most likely first)
            const candidates = [
                { ep: 'offices-all', method: 'GET' },   // admin/all offices
                { ep: 'offices', method: 'GET' }        // department-based (fallback)
            ];

            let res = null;
            let offices = [];

            for (const c of candidates) {
                try {
                    // If using GET, we pass no body (apiCall handles GET properly)
                    if (c.ep === 'offices') {
                        // try without department first
                        res = await apiCall(c.ep, c.method);
                    } else {
                        res = await apiCall(c.ep, c.method);
                    }
                    console.log(`refreshAdminOffices: tried ${c.ep}`, res);
                    if (res && res.success && Array.isArray(res.offices) && res.offices.length > 0) {
                        offices = res.offices;
                        break;
                    } else if (res && res.success && Array.isArray(res.offices) && res.offices.length === 0) {
                        // endpoint returned empty array ‚Äî stop trying other endpoints
                        offices = [];
                        break;
                    }
                    // otherwise try next candidate
                } catch (err) {
                    console.error('refreshAdminOffices error trying', c.ep, err);
                    // continue to next candidate
                }
            }

            // Finalize UI depending on result
            if (!offices || offices.length === 0) {
                listContainer.innerHTML = '<p style="color:var(--gray-600)">No offices found.</p>';
                selectEl.innerHTML = '<option value="">No offices available</option>';
                document.getElementById('officeCount').textContent = '(0 total)';
                return;
            }

            document.getElementById('officeCount').textContent = `(${offices.length} total)`;
            // populate office select
            selectEl.innerHTML = '<option value="">Select Office</option>';
            offices.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.id;
                opt.textContent = o.name || (`Office #${o.id}`);
                selectEl.appendChild(opt);
            });

            // build cards listing
            listContainer.innerHTML = '';
            offices.forEach(o => {
                const node = document.createElement('div');
                node.style.cssText = 'padding:12px;border:1px solid var(--gray-200);border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;';
                node.innerHTML = `
            <div>
                <strong>${escapeHtml(o.name)}</strong>
                <div style="color:var(--gray-500); font-size:13px;">Lat: ${o.latitude || '-'}, Lng: ${o.longitude || '-'} ¬∑ Radius: ${o.radius_meters || '-'}m</div>
                <div style="color:var(--gray-500); font-size:13px;">${o.address || ''}</div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn" onclick="promptEditOffice(${o.id})">‚úèÔ∏è Edit</button>
                <button class="btn btn-secondary" onclick="generateOfficeQR(${o.id})">üîó QR</button>
                <button class="btn btn-error" style="background:var(--error-color); color:#fff;" onclick="deleteOffice(${o.id})">üóëÔ∏è</button>
            </div>
            `;
                listContainer.appendChild(node);
            });
        }


        async function refreshAdminUsers() {
            const tbody = document.getElementById('adminUsersList');
            tbody.innerHTML = '<tr><td colspan="7">Loading users...</td></tr>';
            const res = await apiCall('admin-users', 'GET');

            if (!res || !res.success) {
                tbody.innerHTML = '<tr><td colspan="7" style="color:var(--error-color)">Failed to load users</td></tr>';
                document.getElementById('userCount').textContent = '';
                return;
            }

            const users = res.users || [];
            document.getElementById('userCount').textContent = `(${users.length} total)`;

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No users found.</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(u => `
    <tr>
      <td>${u.id}</td>
      <td>${escapeHtml(u.name)}</td>
      <td>${escapeHtml(u.username)}</td>
      <td>${escapeHtml(u.phone || u.mobile || '')}</td>
      <td>${escapeHtml(u.department || '')}</td>
      <td>${escapeHtml(u.role || '')}</td>
      <td>
        <button class="btn" onclick="promptEditUser(${u.id})">‚úèÔ∏è Edit</button>
        <button class="btn" style="background:#ffcccc;color:#800000;" onclick="deleteUser(${u.id})">üóëÔ∏è Delete</button>
      </td>
    </tr>
  `).join('');
        }

        /* ===== Add Office ===== */
        function clearOfficeForm() {
            document.getElementById('newOfficeName').value = '';
            document.getElementById('newOfficeAddress').value = '';
            document.getElementById('newOfficeLat').value = '';
            document.getElementById('newOfficeLng').value = '';
            document.getElementById('newOfficeRadius').value = '';
            document.getElementById('addOfficeMsg').textContent = '';
        }

        async function submitNewOffice() {
            const name = document.getElementById('newOfficeName').value.trim();
            const address = document.getElementById('newOfficeAddress').value.trim();
            const latitude = document.getElementById('newOfficeLat').value.trim();
            const longitude = document.getElementById('newOfficeLng').value.trim();
            const radius = document.getElementById('newOfficeRadius').value.trim();

            if (!name) return showNotification('Office name is required', 'error');

            const payload = { name, address, latitude: latitude || null, longitude: longitude || null, radius_meters: radius || null };

            // Try common office-create endpoints. Adjust to your backend if different.
            const attempts = ['office', 'offices', 'office-create'];
            let res = null;
            for (const ep of attempts) {
                res = await apiCall(ep, 'POST', payload);
                if (res && res.success) break;
            }

            if (res && res.success) {
                document.getElementById('addOfficeMsg').textContent = 'Office added successfully';
                clearOfficeForm();
                await refreshAdminOffices();
                showNotification('Office created');
            } else {
                console.error('Add office failed:', res);
                showNotification((res && res.message) ? res.message : 'Failed to add office. Check server endpoints.', 'error');
            }
        }

        /* ===== Add User ===== */
        function clearUserForm() {
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserUsername').value = '';
            document.getElementById('newUserPhone').value = '';
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserDepartment').value = '';
            document.getElementById('newUserPrimaryOffice').value = '';
            document.getElementById('newUserRole').value = 'employee';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('addUserMsg').textContent = '';
        }

        async function submitNewUser() {
            const name = document.getElementById('newUserName').value.trim();
            const username = document.getElementById('newUserUsername').value.trim();
            const phone = document.getElementById('newUserPhone').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const department = document.getElementById('newUserDepartment').value;
            const primary_office = document.getElementById('newUserPrimaryOffice').value;
            const role = document.getElementById('newUserRole').value;
            const password = document.getElementById('newUserPassword').value;

            if (!name || !username || !password) return showNotification('Name, username and password are required', 'error');

            // Use the public register endpoint to create a user (most robust). If your backend has a dedicated admin-user-create endpoint, replace 'register'
            const payload = { name, username, password, phone, email, department, primary_office, role };

            const res = await apiCall('register', 'POST', payload);
            if (res && res.success) {
                showNotification('User created successfully');
                clearUserForm();
                await refreshAdminUsers();
            } else {
                console.error('Create user failed:', res);
                showNotification((res && res.message) ? res.message : 'Failed to create user', 'error');
            }
        }

        /* ===== Edit / Delete Office & User ===== */

        function promptEditOffice(id) {
            // load office then prompt fields
            (async () => {
                const r = await apiCall(`office/${id}`, 'GET');
                if (!r || !r.success) return showNotification('Could not load office', 'error');
                const o = r.office;
                const newName = prompt('Office name', o.name);
                if (newName === null) return;
                const newAddress = prompt('Address', o.address || '') || o.address;
                const newLat = prompt('Latitude', o.latitude || '') || o.latitude;
                const newLng = prompt('Longitude', o.longitude || '') || o.longitude;
                const newRadius = prompt('Radius (meters)', o.radius_meters || '') || o.radius_meters;

                const save = await apiCall(`office/${id}`, 'POST', {
                    name: newName, address: newAddress, latitude: newLat, longitude: newLng, radius_meters: newRadius
                });
                if (save && save.success) { showNotification('Office updated'); await refreshAdminOffices(); } else showNotification('Failed to update office', 'error');
            })();
        }

        async function deleteOffice(id) {
            if (!confirm('Delete this office? This action cannot be undone.')) return;
            // Try DELETE then fallback to POST with delete flag
            let res = await apiCall(`office/${id}`, 'DELETE');
            if (!res || !res.success) {
                res = await apiCall(`office/${id}`, 'POST', { delete: true });
            }
            if (res && res.success) { showNotification('Office deleted'); await refreshAdminOffices(); } else { console.error(res); showNotification('Failed to delete office', 'error'); }
        }

        function promptEditUser(id) {
            (async () => {
                const r = await apiCall(`admin-user/${id}`, 'GET');
                if (!r || !r.success) return showNotification('Could not load user', 'error');
                const u = r.user;
                const newName = prompt('Full name', u.name);
                if (newName === null) return;
                const newRole = prompt('Role (admin/employee)', u.role) || u.role;
                const save = await apiCall(`admin-user/${id}`, 'POST', { name: newName, role: newRole });
                if (save && save.success) { showNotification('User updated'); await refreshAdminUsers(); } else showNotification('Failed to update user', 'error');
            })();
        }

        async function deleteUser(id) {
            if (!confirm('Delete this user? This action cannot be undone.')) return;
            // Try delete endpoint or fallback
            let res = await apiCall(`admin-user/${id}`, 'DELETE');
            if (!res || !res.success) {
                res = await apiCall(`admin-user/${id}`, 'POST', { delete: true });
            }
            if (res && res.success) { showNotification('User deleted'); await refreshAdminUsers(); } else { console.error(res); showNotification('Failed to delete user', 'error'); }
        }

        /* ===== Small helpers ===== */
        function escapeHtml(s) {
            if (!s && s !== 0) return '';
            return String(s).replace(/[&<>"']/g, function (m) { return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]; });
        }

        /* ===== optional: generate QR placeholder (if server supports it) ===== */
        function generateOfficeQR(id) {
            // If your backend can generate a QR or a url for check-in, open it. Placeholder for now:
            showNotification('QR generation not implemented on frontend ‚Äî implement on server to return QR link', 'warning');
        }


        // Export Functions
        async function exportToExcel() {
            if (currentUser.role !== 'admin') {
                showNotification('Export feature is available for admin users only', 'warning');
                return;
            }

            try {
                showNotification('Generating report...', 'success');

                // GET with no body; or pass filters as query params: apiCall('attendance-records','GET',{start_date:...,employee_id:...})
                const result = await apiCall('attendance-records', 'GET');

                if (!result || !result.success) {
                    console.error('Export failed - server response:', result);
                    showNotification(result && result.message ? result.message : 'No records to export', 'warning');
                    return;
                }

                if (!result.records || result.records.length === 0) {
                    showNotification('No records to export', 'warning');
                    return;
                }

                // Create CSV content
                const headers = ['Employee Name', 'Department', 'Date', 'Check In', 'Check Out', 'Total Hours', 'Type', 'Status', 'Office', 'Image'];
                const rows = result.records.map(record => [
                    record.employee_name || '',
                    record.department || '',
                    record.date || '',
                    record.check_in_time || '',
                    record.check_out_time || '',
                    (typeof record.total_hours === 'number') ? record.total_hours.toFixed(1) : (record.total_hours ? String(record.total_hours) : '0'),
                    record.type ? record.type.toUpperCase() : '',
                    record.status ? String(record.status).replace('_', ' ').toUpperCase() : '',
                    record.office_name || '',
                    record.photo_url || ''
                ]);

                const csvContent = [headers, ...rows]
                    .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                    .join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance_report_${getCurrentDateTime().date}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification('Report exported successfully!');
            } catch (error) {
                console.error('Error exporting data:', error);
                showNotification('Error exporting data', 'error');
            }
        }


        // Modal Functions
        function showModal(modalId, message) {
            const modal = document.getElementById(modalId);

            if (modalId === 'successModal') {
                const messageEl = document.getElementById('successMessage');
                if (messageEl) messageEl.textContent = message;

                // Auto-close and redirect after 2 seconds
                setTimeout(() => {
                    closeModal(modalId);
                    showScreen('dashboardScreen');
                    loadDashboardData();
                }, 2000);
            }

            modal.classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Utility Functions
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Earth radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function openAdminPanel() {
            showScreen('adminScreen');
            await loadAdminUsers();
            await loadAdminOffices();
        }

        async function loadAdminUsers() {
            const container = document.getElementById('adminUsersList');
            container.innerHTML = 'Loading...';
            const r = await apiCall('admin-users', 'GET');
            if (!r.success) { container.innerText = 'Failed to load users'; return; }
            const users = r.users || [];
            container.innerHTML = users.map(u => `<div style="padding:8px;border-radius:6px;border:1px solid #eee;margin-bottom:8px;">
        <strong>${u.name} (${u.username})</strong><div class="muted">${u.department || ''} ‚Äî ${u.role}</div>
        <div style="margin-top:8px"><button class="btn btn-secondary" onclick="editUser(${u.id})">Edit</button></div></div>`).join('') || '<p>No users</p>';
        }

        async function editUser(userId) {
            const r = await apiCall('admin-user/' + userId, 'GET');
            if (!r.success) return showNotification('Could not load user', 'error');
            const u = r.user;
            const newName = prompt('Full name', u.name);
            if (newName === null) return;
            const newRole = prompt('Role (admin/employee)', u.role) || u.role;
            const save = await apiCall('admin-user/' + userId, 'POST', { name: newName, role: newRole });
            if (save.success) { showNotification('User updated'); loadAdminUsers(); } else showNotification('Failed to update');
        }

        async function loadAdminOffices() {
            const container = document.getElementById('adminOfficesList');
            container.innerHTML = 'Loading...';
            const r = await apiCall('offices-all', 'GET');
            if (!r.success) { container.innerText = 'Failed to load offices'; return; }
            container.innerHTML = r.offices.map(o => `<div style="padding:8px;border-radius:6px;border:1px solid #eee;margin-bottom:8px;">
        <strong>${o.name}</strong><div class="muted">${o.address || ''}</div>
        <div style="margin-top:8px"><button class="btn btn-secondary" onclick="editOffice('${o.id}')">Edit</button></div></div>`).join('');
        }

        async function editOffice(officeId) {
            const r = await apiCall('office/' + officeId, 'GET');
            if (!r.success) return showNotification('Could not load office', 'error');
            const o = r.office;
            const newName = prompt('Office name', o.name); if (newName === null) return;
            const newAddress = prompt('Address', o.address) || o.address;
            const newLat = prompt('Latitude', o.latitude) || o.latitude;
            const newLng = prompt('Longitude', o.longitude) || o.longitude;
            const newRadius = prompt('Radius (meters)', o.radius_meters) || o.radius_meters;
            const save = await apiCall('office/' + officeId, 'POST', { name: newName, address: newAddress, latitude: newLat, longitude: newLng, radius_meters: newRadius });
            if (save.success) { showNotification('Office updated'); loadAdminOffices(); } else showNotification('Failed to update office');
        }
    </script>



</body>

</html>